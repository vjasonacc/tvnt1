<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <title>KMB Bus Service Update</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#003d6b" />
  <style>
    :root {
      --brand: #003d6b;
      --ok: #2e7d32;
      --warn: #ff9800;
      --bad: #c62828;
      --bg: #ffffff;
      --muted: #6b7280;
      --card: #f5f7fa;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans CJK TC", "PingFang TC", "Heiti TC", Arial, sans-serif;
      background: var(--bg);
      color: #111827;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--brand);
      color: #fff;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header .title { font-size: 16px; font-weight: 700; letter-spacing: .3px; }
    header .clock { font-variant-numeric: tabular-nums; font-weight: 700; }
    main { padding: 12px; max-width: 900px; margin: 0 auto; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
    }
    .controls { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 8px; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="text"], select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      background: #fff;
    }
    .chip-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      color: #111827;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
    }
    .chip.active { background: var(--brand); color: #fff; border-color: var(--brand); }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    button {
      appearance: none;
      border: none;
      background: var(--brand);
      color: #fff;
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
    }
    button.secondary { background: #2563eb; }
    button.ghost { background: transparent; color: var(--brand); border: 1px solid var(--brand); }
    .status { margin-top: 12px; display: grid; gap: 8px; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 14px;
      border: 1px solid var(--border);
      background: #fff;
      width: 100%;
      justify-content: center;
      text-align: center;
    }
    .badge.ok { color: var(--ok); border-color: rgba(46,125,50,.25); background: #e8f5e9; }
    .badge.warn { color: var(--warn); border-color: rgba(255,152,0,.25); background: #fff3e0; }
    .badge.bad { color: var(--bad); border-color: rgba(198,40,40,.25); background: #ffebee; }
    .meta { font-size: 12px; color: var(--muted); display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
    .list { margin-top: 12px; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: #fff; }
    .section { border-bottom: 1px solid var(--border); }
    .section-header { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; font-weight: 700; }
    .rows { padding: 8px 0; }
    .rowitem {
      display: grid; grid-template-columns: auto 1fr; gap: 8px; padding: 10px 12px; border-top: 1px solid var(--border); align-items: start;
    }
    .rowitem:first-child { border-top: none; }
    .seq { min-width: 40px; font-weight: 700; color: var(--muted); text-align: right; padding-right: 4px; }
    .title2 { font-weight: 700; margin-bottom: 4px; line-height: 1.2; }
    .rmk { display: inline-block; margin-top: 2px; padding: 3px 8px; border-radius: 6px; font-size: 12px; line-height: 1; background: #e5f1fb; color: #2176ae; }
    .rmk.bad { background: #fee; color: #b31c1c; }
    .eta { margin-top: 6px; font-size: 12px; color: var(--muted); }
    .empty, .loading, .error { text-align: center; color: var(--muted); padding: 16px; font-size: 14px; }
    .tips { margin-top: 12px; color: var(--muted); font-size: 12px; text-align: center; }
    footer.footer { margin: 16px 0; color: var(--muted); font-size: 12px; text-align: center; }
    @media (min-width: 640px) {
      header .title { font-size: 18px; }
      .controls .row { grid-template-columns: 180px 1fr; align-items: center; }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">KMB Bus Service Update</div>
    <div class="clock" id="clock">--:--:--</div>
  </header>

  <main>
    <div class="card">
      <div class="controls">
        <div class="row">
          <label for="routes">路線編號（支援多個，逗號或空白分隔，最多1000；或輸入 ALL）</label>
          <input id="routes" type="text" placeholder="例如：276A, 269C 33 或 ALL" inputmode="latin-name" autocapitalize="characters" />
        </div>

        <div class="row">
          <label>方向</label>
          <div class="chip-group" id="dirChips">
            <div class="chip" data-value="outbound">往目的地 (outbound)</div>
            <div class="chip" data-value="inbound">返回程 (inbound)</div>
            <div class="chip" data-value="both">兩方向 (both)</div>
          </div>
        </div>

        <div class="row">
          <label>服務類型</label>
          <div class="chip-group" id="svcChips">
            <div class="chip" data-value="1">1</div>
            <div class="chip" data-value="2">2</div>
            <div class="chip" data-value="A">A</div>
            <div class="chip" data-value="all">全部</div>
          </div>
        </div>

        <div class="row">
          <div class="actions">
            <button id="checkBtn" aria-label="Check congestion">查詢</button>
            <button id="refreshBtn" class="secondary" aria-label="Refresh">重新整理</button>
            <button id="shareBtn" class="ghost" aria-label="Share link">分享</button>
            <button id="allRoutesBtn" class="ghost" aria-label="Load all KMB routes (HK)">全港所有路線（兩方向）</button>
          </div>
        </div>
      </div>

      <div class="status" id="statusArea" style="display:none;">
        <div id="statusBadge" class="badge">載入中…</div>
        <div class="meta" id="metaText"></div>
      </div>
    </div>

    <div id="results" class="list" style="display:none;"></div>

    <div class="tips">
      資料來源：九巴即時到站（政府資料一線通）<br />
      關鍵字判斷：受阻／行車受阻／延誤／行車緩慢／緩慢<br />
      提示：查詢所有路線可能非常耗時，請耐心等候。
    </div>

    <footer class="footer" id="footer-info">
      最後更新：--:--:-- · 版本：2
    </footer>
  </main>

  <script>
    // -------- Utilities --------
    const $ = (sel) => document.querySelector(sel);
    const pad2 = (n) => (n > 9 ? '' : '0') + n;
    const nowStr = () => {
      const d = new Date();
      let h = d.getHours();
      const m = d.getMinutes();
      const s = d.getSeconds();
      h = h % 12 || 12;
      return h + ':' + pad2(m) + ':' + pad2(s);
    };
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // -------- Clock --------
    const clock = $('#clock');
    clock.textContent = nowStr();
    setInterval(() => (clock.textContent = nowStr()), 1000);

    // -------- Params --------
    function getParam(name, fallback = '') {
      const url = new URL(window.location.href);
      return url.searchParams.get(name) ?? fallback;
    }
    function safeSetParamsMulti(routes, dirSel, svcSel, { all = false } = {}) {
      const url = new URL(window.location.href);
      try {
        const routeParam = all ? 'ALL' : routes.join(',');
        url.searchParams.set('route', routeParam);
        url.searchParams.set('bound', dirSel);
        url.searchParams.set('serviceType', svcSel.join(','));
        history.replaceState(null, '', url.toString());
      } catch {
        // ignore URL update failures
      }
    }

    // -------- API --------
    const API = 'https://data.etabus.gov.hk/v1/transport/kmb';
    const JAM_KEYWORDS = ['行車受阻','受阻','延誤','行車緩慢','緩慢'];
    const OK_TEXT = '服務正常';
    const WARN_TEXT = '可能延誤／行車緩慢';
    const BAD_TEXT = '行車受阻';

    async function fetchJSON(url, { retries = 2, retryDelay = 500 } = {}) {
      for (let i = 0; i <= retries; i++) {
        try {
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return await res.json();
        } catch (e) {
          if (i === retries) throw e;
          await sleep(retryDelay * (i + 1));
        }
      }
    }

    // Concurrency map with progress callback
    async function pMap(arr, mapper, concurrency = 8, onProgress) {
      const ret = new Array(arr.length);
      let idx = 0, done = 0;
      const workers = Array(Math.min(concurrency, arr.length)).fill(0).map(async () => {
        while (true) {
          const i = idx++;
          if (i >= arr.length) break;
          ret[i] = await mapper(arr[i], i);
          done++;
          if (onProgress) onProgress(done, arr.length);
        }
      });
      await Promise.all(workers);
      return ret;
    }

    const stopNameCache = new Map();
    async function getStopName(stopId) {
      if (stopNameCache.has(stopId)) return stopNameCache.get(stopId);
      try {
        const data = await fetchJSON(`${API}/stop/${stopId}`);
        const name = data?.data?.name_tc || stopId;
        stopNameCache.set(stopId, name);
        return name;
      } catch { return stopId; }
    }

    function containsJamKeyword(text) {
      if (!text) return false;
      return JAM_KEYWORDS.some(k => text.includes(k));
    }
    function severityOf(text) {
      if (!text) return 0;
      if (text.includes('行車受阻') || text.includes('受阻')) return 2;
      if (text.includes('延誤') || text.includes('行車緩慢') || text.includes('緩慢')) return 1;
      return 0;
    }

    async function getRouteMeta(route, bound, svc) {
      try {
        const j = await fetchJSON(`${API}/route/${route}/${bound}/${svc}`);
        return j?.data || null;
      } catch { return null; }
    }
    async function getStopsForRoute(route, bound, svc) {
      const j = await fetchJSON(`${API}/route-stop/${route}/${bound}/${svc}`);
      return j?.data || [];
    }
    async function getETAForStopRoute(stopId, route, svc) {
      const j = await fetchJSON(`${API}/eta/${stopId}/${route}/${svc}`);
      return j?.data || [];
    }

    // -------- Core: Single combination detection --------
    async function detectJamForCombo({ route, bound, svc }) {
      const startedAt = Date.now();
      const dirChar = bound === 'inbound' ? 'I' : 'O';
      let stops = [];
      try {
        stops = await getStopsForRoute(route, bound, svc);
      } catch (e) {
        return { route, bound, svc, meta: null, hits: [], maxSeverity: 0, tookMs: Date.now() - startedAt, error: e.message || String(e) };
      }

      const results = await pMap(stops, async (stop) => {
        try {
          const etas = await getETAForStopRoute(stop.stop, route, svc);
          const list = etas.filter(x => x?.eta && x?.dir === dirChar);
          const hit = list.find(x => x.rmk_tc && x.rmk_tc !== '原定班次' && containsJamKeyword(x.rmk_tc));
          if (hit) {
            return { stopId: stop.stop, seq: Number(stop.seq), remark: hit.rmk_tc, eta: hit.eta };
          }
        } catch {}
        return null;
      }, 6);

      const hits = results.filter(Boolean).sort((a, b) => a.seq - b.seq);
      let maxSeverity = 0; for (const h of hits) maxSeverity = Math.max(maxSeverity, severityOf(h.remark));
      const meta = await getRouteMeta(route, bound, svc).catch(() => null);

      return { route, bound, svc, meta, hits, maxSeverity, tookMs: Date.now() - startedAt };
    }

    // -------- Multi detection --------
    async function detectJamMulti({ routes, dirSel, svcSel, onProgress }) {
      const bounds = dirSel === 'both' ? ['outbound','inbound'] : [dirSel];
      const svcs = svcSel.includes('all') ? ['1','2','A'] : svcSel;
      const tasks = [];
      for (const r of routes) for (const b of bounds) for (const s of svcs) tasks.push({ route: r, bound: b, svc: s });
      const startedAt = Date.now();
      const outcomes = await pMap(tasks, detectJamForCombo, 6, onProgress);
      const tookMs = Date.now() - startedAt;
      let overall = 0;
      for (const o of outcomes) overall = Math.max(overall, o.maxSeverity || 0);
      return { outcomes, overall, tookMs };
    }

    // -------- UI Binding --------
    const routesInput = $('#routes');
    const dirChips = $('#dirChips');
    const svcChips = $('#svcChips');
    const checkBtn = $('#checkBtn');
    const refreshBtn = $('#refreshBtn');
    const shareBtn = $('#shareBtn');
    const allRoutesBtn = $('#allRoutesBtn');

    const statusArea = $('#statusArea');
    const statusBadge = $('#statusBadge');
    const metaText = $('#metaText');
    const results = $('#results');
    const footerInfo = $('#footer-info');

    function setFooterUpdated() { footerInfo.textContent = `最後更新：${nowStr()} · 版本：2`; }

    function setActive(chipEl, active) { chipEl.classList.toggle('active', !!active); }
    function getDirSelection() {
      const active = [...dirChips.querySelectorAll('.chip.active')].map(c => c.dataset.value);
      if (active.includes('both')) return 'both';
      if (active.includes('outbound') && active.includes('inbound')) return 'both';
      return active[0] || 'outbound';
    }
    function getSvcSelection() {
      let active = [...svcChips.querySelectorAll('.chip.active')].map(c => c.dataset.value);
      if (active.includes('all')) return ['all'];
      if (active.length === 0) active = ['1'];
      return active;
    }
    function setFromParams() {
      const routeParam = (getParam('route') || '').trim();
      const boundParam = (getParam('bound') || 'outbound').toLowerCase();
      const svcParam = (getParam('serviceType') || '1');

      routesInput.value = routeParam;

      [...dirChips.children].forEach(c => setActive(c, false));
      const dirToActivate = (boundParam === 'both') ? ['both'] : [boundParam];
      dirToActivate.forEach(v => {
        const el = dirChips.querySelector(`.chip[data-value="${v}"]`);
        if (el) setActive(el, true);
      });
      if (![...dirChips.querySelectorAll('.chip.active')].length) {
        setActive(dirChips.querySelector('.chip[data-value="outbound"]'), true);
      }

      [...svcChips.children].forEach(c => setActive(c, false));
      const svcVals = svcParam.split(',').map(s => s.trim()).filter(Boolean);
      if (svcVals.includes('all')) {
        setActive(svcChips.querySelector('.chip[data-value="all"]'), true);
      } else {
        svcVals.forEach(v => {
          const el = svcChips.querySelector(`.chip[data-value="${v}"]`);
          if (el) setActive(el, true);
        });
        if (![...svcChips.querySelectorAll('.chip.active')].length) {
          setActive(svcChips.querySelector('.chip[data-value="1"]'), true);
        }
      }
    }

    dirChips.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip'); if (!chip) return;
      const val = chip.dataset.value;
      if (val === 'both') {
        [...dirChips.children].forEach(c => setActive(c, c.dataset.value === 'both'));
      } else {
        const was = chip.classList.contains('active');
        if (was && dirChips.querySelectorAll('.chip.active').length === 1) return;
        setActive(chip, !was);
        setActive(dirChips.querySelector('.chip[data-value="both"]'), false);
        if (!dirChips.querySelector('.chip.active')) setActive(dirChips.querySelector('.chip[data-value="outbound"]'), true);
      }
    });

    svcChips.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip'); if (!chip) return;
      const val = chip.dataset.value;
      if (val === 'all') {
        [...svcChips.children].forEach(c => setActive(c, c.dataset.value === 'all'));
      } else {
        const was = chip.classList.contains('active');
        setActive(chip, !was);
        setActive(svcChips.querySelector('.chip[data-value="all"]'), false);
        if (!svcChips.querySelector('.chip.active')) setActive(chip, true);
      }
    });

    function normalizeRoutes(input) {
      const parts = input.split(/[\s,]+/).map(x => x.trim().toUpperCase()).filter(Boolean);
      const uniq = [...new Set(parts)].slice(0, 1000);
      return uniq;
    }

    // Handle ALL token
    async function gatherRoutes() {
      const value = routesInput.value.trim().toUpperCase();
      if (value === 'ALL') {
        return await fetchAllRouteCodes(1000);
      }
      return normalizeRoutes(value);
    }

    function setBusy(busy, { auto = false } = {}) {
      // Do not hide results to avoid flashing; only adjust controls on manual runs
      checkBtn.disabled = busy && !auto;
      refreshBtn.disabled = busy && !auto;
      routesInput.disabled = busy && !auto;
      allRoutesBtn.disabled = busy && !auto;
      statusArea.style.display = 'block';
      statusBadge.textContent = busy ? (auto ? '更新中…' : '分析中…') : statusBadge.textContent;
      // Keep results visible during refresh
    }

    function renderProgress(completed, total) {
      const pct = total ? Math.round((completed / total) * 100) : 0;
      const safePct = isFinite(pct) ? pct : 0;
      const pieces = metaText.innerHTML ? metaText.innerHTML.split('</span>') : [];
      // Append or update a progress piece
      const progText = `<span>進度：${completed}/${total}（${safePct}%）</span>`;
      // Simple approach: always rebuild meta with current progress appended
      // Keep last update and other info on final render
      metaText.innerHTML = progText;
    }

    function renderMultiOutcome(summary) {
      const { outcomes, overall, tookMs } = summary;
      statusArea.style.display = 'block';
      results.style.display = 'block';

      if (overall === 0) {
        statusBadge.className = 'badge ok';
        statusBadge.textContent = `✅ ${OK_TEXT}`;
      } else if (overall >= 2) {
        statusBadge.className = 'badge bad';
        statusBadge.textContent = `⛔ ${BAD_TEXT}`;
      } else {
        statusBadge.className = 'badge warn';
        statusBadge.textContent = `⚠️ ${WARN_TEXT}`;
      }

      const hitCombos = outcomes.filter(o => (o?.hits?.length || 0) > 0).length;
      metaText.innerHTML = `
        <span>組合數：${outcomes.length}</span>
        <span>有異常組合：${hitCombos}</span>
        <span>上次更新：${nowStr()}</span>
        <span>耗時：${tookMs}ms</span>
      `;

      // Update footer time
      setFooterUpdated();

      if (outcomes.length === 0) {
        results.innerHTML = `<div class="empty">沒有可顯示的組合</div>`;
        return;
      }

      const sectionHtml = outcomes.map((o) => {
        const dirLabel = o.bound === 'outbound' ? '往目的地' : '返回程';
        const dest = o.meta?.dest_tc ? ` → ${o.meta.dest_tc}` : '';
        const sev = o.maxSeverity || 0;
        const subBadge = sev === 0 ? '✅ 正常' : sev >= 2 ? '⛔ 受阻' : '⚠️ 緩慢/延誤';

        if ((o.hits?.length || 0) === 0) {
          return `
            <div class="section" data-key="${o.route}-${o.bound}-${o.svc}">
              <div class="section-header">
                <div>${o.route}${dest}｜${dirLabel}｜服務類型：${o.svc}</div>
                <div>${subBadge}</div>
              </div>
              <div class="rows">
                <div class="empty">未偵測到包含關鍵字的提示。</div>
              </div>
            </div>
          `;
        }

        const placeholderId = `rows-${o.route}-${o.bound}-${o.svc}`.replace(/[^a-zA-Z0-9_-]/g,'_');
        // Asynchronously resolve names and update the rows container in-place
        Promise.all(o.hits.map(h => getStopName(h.stopId))).then(names => {
          const rowsEl = document.getElementById(placeholderId);
          if (!rowsEl) return;
          rowsEl.innerHTML = o.hits.map((h, i) => {
            const name = names[i] || h.stopId;
            const s = severityOf(h.remark);
            const rmkClass = s >= 2 ? 'rmk bad' : 'rmk';
            const t = h.eta ? new Date(h.eta) : null;
            const etaStr = t ? `${(t.getHours()%12)||12}:${pad2(t.getMinutes())}` : '--:--';
            return `
              <div class="rowitem">
                <div class="seq">${h.seq}.</div>
                <div>
                  <div class="title2">${name}</div>
                  <span class="${rmkClass}">${h.remark}</span>
                  <div class="eta">下一班到達時間：${etaStr}</div>
                </div>
              </div>
            `;
          }).join('');
        });

        return `
          <div class="section" data-key="${o.route}-${o.bound}-${o.svc}">
            <div class="section-header">
              <div>${o.route}${dest}｜${dirLabel}｜服務類型：${o.svc}</div>
              <div>${subBadge}</div>
            </div>
            <div class="rows" id="${placeholderId}">
              <div class="loading">載入站點詳情…</div>
            </div>
          </div>
        `;
      }).join('');

      // Replace sections content but keep container visible to avoid flash
      results.innerHTML = sectionHtml;
    }

    let lastQueryKey = '';
    let autoTimer = null;
    let usingAllRoutes = false;

    async function runDetect(force = false, { auto = false } = {}) {
      const dirSel = getDirSelection();
      const svcSel = getSvcSelection();

      // Determine routes
      let routes;
      const value = routesInput.value.trim().toUpperCase();
      if (value === 'ALL') {
        usingAllRoutes = true;
        routes = await fetchAllRouteCodes(1000);
      } else {
        usingAllRoutes = false;
        routes = normalizeRoutes(value);
      }

      if (routes.length === 0) {
        alert('請輸入至少一個路線編號（例如：276A 或 276A,269C，或輸入 ALL）');
        return;
      }

      const key = JSON.stringify({ routesKey: usingAllRoutes ? 'ALL' : routes.join(','), dirSel, svcSel });
      if (!force && key === lastQueryKey) {
        // same params
      } else {
        // If too long, store as ALL; otherwise store actual list
        const tooLong = routes.join(',').length > 200 || usingAllRoutes;
        safeSetParamsMulti(routes, dirSel, svcSel, { all: tooLong });
      }
      lastQueryKey = key;

      setBusy(true, { auto });
      try {
        const summary = await detectJamMulti({
          routes, dirSel, svcSel,
          onProgress: (completed, total) => {
            // Only show progress during long manual runs to avoid noisy updates in auto refresh
            if (!auto) renderProgress(completed, total);
          }
        });
        renderMultiOutcome(summary);
      } catch (e) {
        statusArea.style.display = 'block';
        statusBadge.className = 'badge';
        statusBadge.textContent = '❌ 載入失敗';
        results.style.display = 'block';
        const msg = (e && e.message) ? e.message : String(e || '未知錯誤');
        // Keep existing results; just show an inline error
        metaText.innerHTML = `<span style="color:#b31c1c;">錯誤：${msg}</span>`;
      } finally {
        setBusy(false, { auto });
      }
    }

    function startAutoRefresh() {
      if (autoTimer) clearInterval(autoTimer);
      autoTimer = setInterval(() => runDetect(true, { auto: true }), 30000);
    }

    // Load all KMB route codes via API and run both directions
    async function fetchAllRouteCodes(limit = 1000) {
      const j = await fetchJSON(`${API}/route`);
      const list = (j?.data || []).map(x => (x.route || '').toUpperCase()).filter(Boolean);
      const uniq = [...new Set(list)].sort((a, b) => a.localeCompare(b, 'zh-HK', { numeric: true }));
      return uniq.slice(0, limit);
    }

    // Events
    $('#checkBtn').addEventListener('click', () => { runDetect(); startAutoRefresh(); });
    $('#refreshBtn').addEventListener('click', () => runDetect(true));
    $('#shareBtn').addEventListener('click', async () => {
      // When sharing, if ALL mode or too long, share with route=ALL
      const dirSel = getDirSelection();
      const svcSel = getSvcSelection();
      const value = routesInput.value.trim().toUpperCase();
      const routes = (value === 'ALL') ? ['ALL'] : normalizeRoutes(value);
      const tooLong = routes.join(',').length > 200 || value === 'ALL';
      const url = new URL(window.location.href);
      url.searchParams.set('route', tooLong ? 'ALL' : routes.join(','));
      url.searchParams.set('bound', dirSel);
      url.searchParams.set('serviceType', svcSel.join(','));
      const shareUrl = url.toString();
      try {
        if (navigator.share) {
          await navigator.share({ title: 'KMB Bus Service Update', url: shareUrl });
        } else if (navigator.clipboard) {
          await navigator.clipboard.writeText(shareUrl);
          alert('已複製分享連結到剪貼簿');
        } else {
          prompt('複製以下連結：', shareUrl);
        }
      } catch {}
    });

    // NEW: All routes button
    $('#allRoutesBtn').addEventListener('click', async () => {
      if (!confirm('此操作會抓取全港所有九巴路線並以「兩方向」分析，可能非常耗時並消耗流量。是否繼續？')) return;
      try {
        // Mark ALL mode in input to trigger special handling (no huge URL injection)
        routesInput.value = 'ALL';
        // force direction to both
        [...dirChips.children].forEach(c => c.classList.remove('active'));
        const bothEl = dirChips.querySelector('.chip[data-value="both"]');
        if (bothEl) bothEl.classList.add('active');
        await runDetect(true);
        startAutoRefresh();
      } catch (e) {
        alert('抓取所有路線失敗：' + (e.message || e));
      }
    });

    // Init from URL
    setFromParams();
    // If route=ALL in URL, leave the input as ALL; otherwise use the provided list.
    const initial = (getParam('route') || '').trim().toUpperCase();
    if (initial) {
      if (initial === 'ALL') routesInput.value = 'ALL';
      runDetect(false);
      startAutoRefresh();
    }
  </script>
</body>
</html>
