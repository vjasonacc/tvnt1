<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <title>KMB Bus Service Update</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#003d6b" />
  <style>
    :root {
      --brand: #003d6b;
      --ok: #2e7d32;
      --warn: #ff9800;
      --bad: #c62828;
      --bg: #ffffff;
      --muted: #6b7280;
      --card: #f5f7fa;
      --border: #e5e7eb;
      --line: #e5e7eb;
      --pill-red-bg: #ffe8e8;
      --pill-red-fg: #b31c1c;
      --pill-amber-bg: #fff3e0;
      --pill-amber-fg: #a15c00;
      --text-strong: #0f172a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans CJK TC", "PingFang TC", "Heiti TC", Arial, sans-serif;
      background: var(--bg);
      color: #111827;
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: var(--brand); color: #fff; padding: 12px 16px;
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
    }
    header .title { font-size: 16px; font-weight: 700; letter-spacing: .3px; }
    header .clock { font-variant-numeric: tabular-nums; font-weight: 700; }
    main { padding: 12px; max-width: 900px; margin: 0 auto; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
    .controls { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 8px; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="text"] {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; background: #fff;
    }
    .chip-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip {
      padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border);
      background: #fff; color: #111827; font-weight: 600; font-size: 14px; cursor: pointer; user-select: none;
    }
    .chip.active { background: var(--brand); color: #fff; border-color: var(--brand); }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    button {
      appearance: none; border: none; background: var(--brand); color: #fff;
      padding: 10px 14px; font-size: 16px; border-radius: 10px; font-weight: 700; cursor: pointer;
    }
    button.secondary { background: #2563eb; }
    button.ghost { background: transparent; color: var(--brand); border: 1px solid var(--brand); }
    .status { margin-top: 12px; display: grid; gap: 8px; }
    .badge {
      display: inline-flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 999px;
      font-weight: 700; font-size: 14px; border: 1px solid var(--border); background: #fff; width: 100%;
      justify-content: center; text-align: center;
    }
    .badge.ok { color: var(--ok); border-color: rgba(46,125,50,.25); background: #e8f5e9; }
    .badge.warn { color: var(--warn); border-color: rgba(255,152,0,.25); background: #fff3e0; }
    .badge.bad { color: var(--bad); border-color: rgba(198,40,40,.25); background: #ffebee; }
    .meta { font-size: 12px; color: var(--muted); display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }

    .list { margin-top: 12px; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: #fff; }
    .section { border-bottom: 1px solid var(--border); }
    .section-header { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; font-weight: 700; }
    .rows { padding: 8px 12px; }

    /* Stop row and ETA list styles */
    .rowitem { padding: 10px 0; border-top: 1px solid var(--line); }
    .rowitem:first-child { border-top: none; }
    .stop-head { display: flex; gap: 10px; align-items: baseline; margin-bottom: 6px; }
    .seq { min-width: 40px; font-weight: 700; color: var(--muted); text-align: right; padding-right: 4px; }
    .title2 { font-weight: 700; line-height: 1.2; }
    .eta-ul { list-style: none; margin: 0; padding: 0; }
    .eta-li { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-top: 1px dashed var(--line); }
    .eta-li:first-child { border-top: none; }
    .eta-left { display: flex; align-items: baseline; gap: 6px; flex-wrap: wrap; }
    .eta-min { font-family: Arial, sans-serif; font-weight: 800; font-size: 22px; color: var(--text-strong); }
    .eta-min-text { font-weight: 700; color: var(--text-strong); }
    .eta-time { font-variant-numeric: tabular-nums; color: var(--muted); font-weight: 700; }
    .eta-rmk { display: inline-block; padding: 6px 10px; border-radius: 12px; font-size: 12px; margin-top: 6px; }
    .eta-rmk.bad { background: var(--pill-red-bg); color: var(--pill-red-fg); }
    .eta-rmk.warn { background: var(--pill-amber-bg); color: var(--pill-amber-fg); }

    .empty, .loading, .error, .na, .transient { text-align: center; color: var(--muted); padding: 12px; font-size: 14px; }
    .tips { margin-top: 12px; color: var(--muted); font-size: 12px; text-align: center; }
    footer.footer { margin: 16px 0; color: var(--muted); font-size: 12px; text-align: center; }

    @media (min-width: 640px) {
      header .title { font-size: 18px; }
      .controls .row { grid-template-columns: 180px 1fr; align-items: center; }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">KMB Bus Service Update</div>
    <div class="clock" id="clock">--:--:--</div>
  </header>

  <main>
    <div class="card">
      <div class="controls">
        <div class="row">
          <label for="routes">路線編號（支援多個，逗號或空白分隔，最多1000；或輸入 ALL）</label>
          <input id="routes" type="text" placeholder="例如：276A, 269C 33 或 ALL" inputmode="latin-name" autocapitalize="characters" />
        </div>

        <div class="row">
          <label>方向</label>
          <div class="chip-group" id="dirChips">
            <div class="chip" data-value="outbound">往目的地 (outbound)</div>
            <div class="chip" data-value="inbound">返回程 (inbound)</div>
            <div class="chip" data-value="both">兩方向 (both)</div>
          </div>
        </div>

        <div class="row">
          <label>服務類型</label>
          <div class="chip-group" id="svcChips">
            <div class="chip" data-value="1">1</div>
            <div class="chip" data-value="2">2</div>
            <div class="chip" data-value="A">A</div>
            <div class="chip" data-value="all">全部</div>
          </div>
        </div>

        <div class="row">
          <div class="actions">
            <button id="checkBtn" aria-label="Check congestion">查詢</button>
            <button id="refreshBtn" class="secondary" aria-label="Refresh">重新整理</button>
            <button id="shareBtn" class="ghost" aria-label="Share link">分享</button>
            <button id="allRoutesBtn" class="ghost" aria-label="Load all KMB routes (HK)">全港所有路線（兩方向）</button>
          </div>
        </div>
      </div>

      <div class="status" id="statusArea" style="display:none;">
        <div id="statusBadge" class="badge">載入中…</div>
        <div class="meta" id="metaText"></div>
      </div>
    </div>

    <div id="results" class="list" style="display:block;"></div>

    <div class="tips">
      資料來源：九巴即時到站（政府資料一線通）<br />
      關鍵字判斷：受阻／行車受阻／延誤／行車緩慢／緩慢
    </div>

    <footer class="footer" id="footer-info">
      最後更新：--:--:-- · 版本：8
    </footer>
  </main>

  <script>
    // -------- Utilities --------
    const $ = (sel) => document.querySelector(sel);
    const pad2 = (n) => (n > 9 ? '' : '0') + n;
    const nowStr = () => {
      const d = new Date(); let h = d.getHours(), m = d.getMinutes(), s = d.getSeconds();
      h = h % 12 || 12; return h + ':' + pad2(m) + ':' + pad2(s);
    };
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const jitter = (ms) => ms + Math.floor(Math.random() * ms * 0.2);
    const toMinAndTime = (iso) => {
      if (!iso) return { min: '--', time: '--:--' };
      const t = new Date(iso), n = new Date();
      const mins = Math.max(0, Math.floor((t - n) / 60000));
      const hh = (t.getHours() % 12) || 12, mm = pad2(t.getMinutes());
      return { min: isNaN(mins) ? '--' : mins, time: `${hh}:${mm}` };
    };

    // -------- Clock --------
    const clock = $('#clock'); clock.textContent = nowStr();
    setInterval(() => (clock.textContent = nowStr()), 1000);

    // -------- Params --------
    function getParam(name, fallback = '') {
      const url = new URL(window.location.href);
      return url.searchParams.get(name) ?? fallback;
    }
    function safeSetParamsMulti(routes, dirSel, svcSel, { all = false } = {}) {
      const url = new URL(window.location.href);
      try {
        const routeParam = all ? 'ALL' : routes.join(',');
        url.searchParams.set('route', routeParam);
        url.searchParams.set('bound', dirSel);
        url.searchParams.set('serviceType', svcSel.join(','));
        history.replaceState(null, '', url.toString());
      } catch {}
    }

    // -------- API & rules --------
    const API = 'https://data.etabus.gov.hk/v1/transport/kmb';
    const JAM_KEYWORDS = ['行車受阻','受阻','延誤','行車緩慢','緩慢'];
    const OK_TEXT = '服務正常';
    const WARN_TEXT = '可能延誤／行車緩慢';
    const BAD_TEXT = '行車受阻';
    const OFFLINE_TEXT = '無法連線 / 離線';
    const NA_TEXT = '不適用（該服務類型未提供）';
    const TRANSIENT_TEXT = '暫時不可用（稍後重試）';

    async function fetchJSON(url, { retries = 3, baseDelay = 500 } = {}) {
      for (let i = 0; i <= retries; i++) {
        try {
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return await res.json();
        } catch (e) {
          if (i === retries) { const err = new Error((e && e.message) || 'NETWORK_ERROR'); err.code = 'NETWORK_ERROR'; throw err; }
          await sleep(jitter(baseDelay * Math.pow(2, i)));
        }
      }
    }

    async function pMap(arr, mapper, concurrency = 4, { onEach, onProgress } = {}) {
      const ret = new Array(arr.length);
      let idx = 0, done = 0;
      const workers = Array(Math.min(concurrency, arr.length)).fill(0).map(async () => {
        while (true) {
          const i = idx++; if (i >= arr.length) break;
          let out;
          try { out = await mapper(arr[i], i); }
          catch (e) { out = { transient: true, error: (e && e.message) || 'UNKNOWN_ERROR' }; }
          ret[i] = out; done++;
          if (onEach) onEach(out, i, done, arr.length);
          if (onProgress) onProgress(done, arr.length);
        }
      });
      await Promise.all(workers);
      return ret;
    }

    const stopNameCache = new Map();
    async function getStopName(stopId) {
      if (stopNameCache.has(stopId)) return stopNameCache.get(stopId);
      try { const data = await fetchJSON(`${API}/stop/${stopId}`); const name = data?.data?.name_tc || stopId; stopNameCache.set(stopId, name); return name; }
      catch { return stopId; }
    }

    function containsJamKeyword(text) {
      if (!text) return false;
      return JAM_KEYWORDS.some(k => text.includes(k));
    }
    function severityOf(text) {
      if (!text) return 0;
      if (text.includes('行車受阻') || text.includes('受阻')) return 2;
      if (text.includes('延誤') || text.includes('行車緩慢') || text.includes('緩慢')) return 1;
      return 0;
    }

    async function getRouteMeta(route, bound, svc) {
      try { const j = await fetchJSON(`${API}/route/${route}/${bound}/${svc}`); return j?.data || null; }
      catch (e) { if ((e && e.message || '').includes('HTTP 404')) return { NA: true }; return null; }
    }
    async function getStopsForRoute(route, bound, svc) {
      try { const j = await fetchJSON(`${API}/route-stop/${route}/${bound}/${svc}`); return j?.data || []; }
      catch (e) {
        if ((e && e.message || '').includes('HTTP 404')) { const err = new Error('NA'); err.code = 'NA'; throw err; }
        const err = new Error((e && e.message) || 'TRANSIENT'); err.code = 'TRANSIENT'; throw err;
      }
    }
    async function getETAForStopRoute(stopId, route, svc) {
      const j = await fetchJSON(`${API}/eta/${stopId}/${route}/${svc}`);
      return j?.data || [];
    }

    // -------- Core: Single combination detection (collect top 3 ETAs per affected stop) --------
    // Output per combo: { route, bound, svc, meta, na?, transient?, hits:[{ stopId, seq, etas:[{eta, rmk_tc}] , sev }] , maxSeverity, tookMs }
    async function detectJamForCombo({ route, bound, svc }) {
      const startedAt = Date.now();
      const dirChar = bound === 'inbound' ? 'I' : 'O';

      // route-stop (availability)
      let stops = [];
      try { stops = await getStopsForRoute(route, bound, svc); }
      catch (e) {
        if (e && e.code === 'NA') return { route, bound, svc, meta: null, hits: [], maxSeverity: 0, tookMs: Date.now() - startedAt, na: true };
        return { route, bound, svc, meta: null, hits: [], maxSeverity: 0, tookMs: Date.now() - startedAt, transient: true, error: 'route-stop-transient' };
      }

      if (!Array.isArray(stops) || stops.length === 0) {
        return { route, bound, svc, meta: null, hits: [], maxSeverity: 0, tookMs: Date.now() - startedAt, na: true };
      }

      // ETAs for each stop
      let etaErrors = 0;
      const perStop = await pMap(stops, async (stop) => {
        try {
          const all = await getETAForStopRoute(stop.stop, route, svc);
          const list = all
            .filter(x => x?.eta && x?.dir === dirChar)
            .sort((a,b)=> new Date(a.eta) - new Date(b.eta));
          const top3 = list.slice(0, 3).map(x => ({ eta: x.eta, rmk_tc: x.rmk_tc || '' }));
          // Keep stop only if any of the top3 has jam keyword
          const hasHit = top3.some(x => x.rmk_tc && containsJamKeyword(x.rmk_tc));
          if (hasHit) {
            // determine stop-level severity (max of its 3)
            const sev = top3.reduce((m, e) => Math.max(m, severityOf(e.rmk_tc)), 0);
            return { stopId: stop.stop, seq: Number(stop.seq), etas: top3, sev };
          }
          return null;
        } catch {
          etaErrors++;
          return null;
        }
      }, 4);

      // Sort hits: severe stop first, then warning, then by seq
      const hits = perStop
        .filter(Boolean)
        .sort((a, b) => {
          if (b.sev !== a.sev) return b.sev - a.sev;
          return a.seq - b.seq;
        });

      // Combo severity = max across all stop ETAs
      let maxSeverity = 0;
      for (const st of hits) {
        for (const e of st.etas) {
          maxSeverity = Math.max(maxSeverity, severityOf(e.rmk_tc));
        }
      }

      const meta = await getRouteMeta(route, bound, svc).catch(() => null);
      // consider transient if ETA errors are dominant
      const etaTransient = etaErrors / stops.length >= 0.8;

      return { route, bound, svc, meta, hits, maxSeverity, tookMs: Date.now() - startedAt, transient: etaTransient || false };
    }

    // -------- Section ordering: always rank severe on top --------
    function comboOrderValue(o) {
      // Lower value = higher priority
      if (o.na) return 5;
      if (o.transient) return 4;
      if ((o.maxSeverity || 0) >= 2) return 0; // severe (⛔) first
      if ((o.maxSeverity || 0) === 1) return 1; // warning
      if ((o.hits?.length || 0) > 0) return 2;  // has hits but mapped as non-severe/non-warn (rare)
      return 3; // normal
    }
    function reorderSections(container) {
      const sections = Array.from(container.children);
      sections.sort((a, b) => {
        const av = Number(a.getAttribute('data-order') || 99);
        const bv = Number(b.getAttribute('data-order') || 99);
        if (av !== bv) return av - bv;
        // tie-break by route text to keep stable order
        const at = a.querySelector('.sh-left')?.textContent || '';
        const bt = b.querySelector('.sh-left')?.textContent || '';
        return at.localeCompare(bt, 'zh-HK', { numeric: true });
      });
      sections.forEach(s => container.appendChild(s));
    }

    // -------- UI incremental upsert --------
    const resultsEl = $('#results');
    function keyOf(o) { return `${o.route}-${o.bound}-${o.svc}`; }
    function sanitizeId(s) { return s.replace(/[^a-zA-Z0-9_-]/g,'_'); }
    function subBadgeText(sev, flags) {
      if (flags?.na) return 'ℹ️ 不適用';
      if (flags?.transient) return '⏳ 暫時不可用';
      return sev === 0 ? '✅ 正常' : sev >= 2 ? '⛔ 受阻' : '⚠️ 緩慢/延誤';
    }
    function rmkClass(rmk) {
      const s = severityOf(rmk || '');
      return s >= 2 ? 'bad' : s === 1 ? 'warn' : '';
    }

    function upsertSection(o, runId) {
      const key = keyOf(o);
      const id = `section-${sanitizeId(key)}`;
      let section = document.getElementById(id);

      const dirLabel = o.bound === 'outbound' ? '往目的地' : '返回程';
      const dest = o.meta?.dest_tc ? ` → ${o.meta.dest_tc}` : '';
      const subBadge = subBadgeText(o.maxSeverity || 0, { transient: !!o.transient, na: !!o.na });
      const orderVal = comboOrderValue(o);

      if (!section) {
        section = document.createElement('div');
        section.className = 'section';
        section.id = id;
        section.setAttribute('data-key', key);
        section.innerHTML = `
          <div class="section-header">
            <div class="sh-left">${o.route}${dest}｜${dirLabel}｜服務類型：${o.svc}</div>
            <div class="sh-badge">${subBadge}</div>
          </div>
          <div class="rows" id="rows-${sanitizeId(key)}">
            <div class="loading">載入站點詳情…</div>
          </div>
        `;
        resultsEl.appendChild(section);
      } else {
        const shLeft = section.querySelector('.section-header .sh-left');
        const shBadge = section.querySelector('.section-header .sh-badge');
        if (shLeft) shLeft.textContent = `${o.route}${dest}｜${dirLabel}｜服務類型：${o.svc}`;
        if (shBadge) shBadge.textContent = subBadge;
      }

      // rank attributes + run tag
      section.setAttribute('data-run-id', String(runId));
      section.setAttribute('data-order', String(orderVal));

      // Reorder sections so ⛔ are always on top (incrementally)
      reorderSections(resultsEl);

      // Rows content
      const rowsId = `rows-${sanitizeId(key)}`;
      const rowsEl = document.getElementById(rowsId);
      if (!rowsEl) return;

      if (o.na) { rowsEl.innerHTML = `<div class="na">${NA_TEXT}</div>`; return; }
      if (o.transient) { rowsEl.innerHTML = `<div class="transient">${TRANSIENT_TEXT}</div>`; return; }

      if ((o.hits?.length || 0) === 0) {
        rowsEl.innerHTML = `<div class="empty">未偵測到包含關鍵字的提示。</div>`;
      } else {
        // Resolve stop names and render list style
        Promise.all(o.hits.map(h => getStopName(h.stopId))).then(names => {
          rowsEl.innerHTML = o.hits.map((h, i) => {
            const name = names[i] || h.stopId;

            // Build ETA list items (always up to 3, even if same remark)
            const etaLis = (h.etas || []).slice(0, 3).map(et => {
              const { min, time } = toMinAndTime(et.eta);
              const klass = rmkClass(et.rmk_tc);
              const rmkHtml = et.rmk_tc ? `<div class="eta-rmk ${klass}">${et.rmk_tc}</div>` : '';
              return `
                <li class="eta-li">
                  <div class="eta-left">
                    <span class="eta-min">${min}</span><span class="eta-min-text">mins</span>
                    ${rmkHtml}
                  </div>
                  <div class="eta-time">${time}</div>
                </li>
              `;
            }).join('') || `
              <li class="eta-li">
                <div class="eta-left">
                  <span class="eta-min">--</span><span class="eta-min-text">分</span>
                </div>
                <div class="eta-time">--:--</div>
              </li>
            `;

            return `
              <div class="rowitem">
                <div class="stop-head">
                  <div class="seq">${h.seq}.</div>
                  <div class="title2">${name}</div>
                </div>
                <ul class="eta-ul">
                  ${etaLis}
                </ul>
              </div>
            `;
          }).join('');
        });
      }
    }

    // -------- Progress + badge meta --------
    function updateProgressMeta({ total, completed, hitCombos, naCombos, transientCombos, overall, tookMs }) {
      const pct = total ? Math.round((completed / total) * 100) : 0;
      $('#metaText').innerHTML = `
        <span>組合數：${total}</span>
        <span>已完成：${completed}/${total}（${pct}%）</span>
        <span>有異常組合：${hitCombos}</span>
        <span>不適用組合：${naCombos}</span>
        <span>暫時不可用：${transientCombos}</span>
        <span>上次更新：${nowStr()}</span>
        ${typeof tookMs === 'number' ? `<span>耗時：${tookMs}ms</span>` : ''}
      `;

      const badge = $('#statusBadge');
      const applicable = Math.max(0, total - naCombos);
      const mostlyTransient = applicable > 0 && transientCombos / applicable >= 0.8;

      if (!navigator.onLine || mostlyTransient) { badge.className = 'badge bad'; badge.textContent = `❌ ${OFFLINE_TEXT}`; return; }
      if (hitCombos > 0) {
        if (overall >= 2) { badge.className = 'badge bad'; badge.textContent = `⛔ ${BAD_TEXT}`; }
        else { badge.className = 'badge warn'; badge.textContent = `⚠️ ${WARN_TEXT}`; }
        return;
      }
      badge.className = 'badge ok';
      badge.textContent = `✅ ${OK_TEXT}`;
    }

    // -------- Multi detection with incremental rendering --------
    const resultsElRef = $('#results');
    let lastQueryKey = '';
    let autoTimer = null;
    let usingAllRoutes = false;
    let currentRunId = 0;

    function setFooterUpdated() { $('#footer-info').textContent = `最後更新：${nowStr()} · 版本：8`; }

    function setActive(chipEl, active) { chipEl.classList.toggle('active', !!active); }
    function getDirSelection() {
      const active = [...$('#dirChips').querySelectorAll('.chip.active')].map(c => c.dataset.value);
      if (active.includes('both')) return 'both';
      if (active.includes('outbound') && active.includes('inbound')) return 'both';
      return active[0] || 'outbound';
    }
    function getSvcSelection() {
      let active = [...$('#svcChips').querySelectorAll('.chip.active')].map(c => c.dataset.value);
      if (active.includes('all')) return ['all'];
      if (active.length === 0) active = ['1'];
      return active;
    }
    function setFromParams() {
      const routeParam = (getParam('route') || '').trim();
      const boundParam = (getParam('bound') || 'outbound').toLowerCase();
      const svcParam = (getParam('serviceType') || '1');

      $('#routes').value = routeParam;

      [...$('#dirChips').children].forEach(c => setActive(c, false));
      const dirToActivate = (boundParam === 'both') ? ['both'] : [boundParam];
      dirToActivate.forEach(v => { const el = $('#dirChips').querySelector(`.chip[data-value="${v}"]`); if (el) setActive(el, true); });
      if (![...$('#dirChips').querySelectorAll('.chip.active')].length) setActive($('#dirChips').querySelector('.chip[data-value="outbound"]'), true);

      [...$('#svcChips').children].forEach(c => setActive(c, false));
      const svcVals = svcParam.split(',').map(s => s.trim()).filter(Boolean);
      if (svcVals.includes('all')) setActive($('#svcChips').querySelector('.chip[data-value="all"]'), true);
      else {
        svcVals.forEach(v => { const el = $('#svcChips').querySelector(`.chip[data-value="${v}"]`); if (el) setActive(el, true); });
        if (![...$('#svcChips').querySelectorAll('.chip.active')].length) setActive($('#svcChips').querySelector('.chip[data-value="1"]'), true);
      }
    }

    $('#dirChips').addEventListener('click', (e) => {
      const chip = e.target.closest('.chip'); if (!chip) return;
      const val = chip.dataset.value;
      if (val === 'both') { [...$('#dirChips').children].forEach(c => setActive(c, c.dataset.value === 'both')); }
      else {
        const was = chip.classList.contains('active');
        if (was && $('#dirChips').querySelectorAll('.chip.active').length === 1) return;
        setActive(chip, !was); setActive($('#dirChips').querySelector('.chip[data-value="both"]'), false);
        if (!$('#dirChips').querySelector('.chip.active')) setActive($('#dirChips').querySelector('.chip[data-value="outbound"]'), true);
      }
    });

    $('#svcChips').addEventListener('click', (e) => {
      const chip = e.target.closest('.chip'); if (!chip) return;
      const val = chip.dataset.value;
      if (val === 'all') { [...$('#svcChips').children].forEach(c => setActive(c, c.dataset.value === 'all')); }
      else {
        const was = chip.classList.contains('active');
        setActive(chip, !was); setActive($('#svcChips').querySelector('.chip[data-value="all"]'), false);
        if (!$('#svcChips').querySelector('.chip.active')) setActive(chip, true);
      }
    });

    function normalizeRoutes(input) {
      const parts = input.split(/[\s,]+/).map(x => x.trim().toUpperCase()).filter(Boolean);
      const uniq = [...new Set(parts)].slice(0, 1000); return uniq;
    }

    async function gatherRoutes() {
      const value = $('#routes').value.trim().toUpperCase();
      if (value === 'ALL') return await fetchAllRouteCodes(1000);
      return normalizeRoutes(value);
    }

    function setBusy(busy, { auto = false } = {}) {
      $('#checkBtn').disabled = busy && !auto;
      $('#refreshBtn').disabled = busy && !auto;
      $('#routes').disabled = busy && !auto;
      $('#allRoutesBtn').disabled = busy && !auto;
      $('#statusArea').style.display = 'block';
      $('#statusBadge').textContent = busy ? (auto ? '更新中…' : '分析中…') : $('#statusBadge').textContent;
    }

    async function detectJamMulti({ routes, dirSel, svcSel, runId }) {
      const bounds = dirSel === 'both' ? ['outbound','inbound'] : [dirSel];
      const svcs = svcSel.includes('all') ? ['1','2','A'] : svcSel;
      const tasks = [];
      for (const r of routes) for (const b of bounds) for (const s of svcs) tasks.push({ route: r, bound: b, svc: s });

      let completed = 0, hitCombos = 0, naCombos = 0, transientCombos = 0, overall = 0;
      updateProgressMeta({ total: tasks.length, completed, hitCombos, naCombos, transientCombos, overall });

      const startedAt = Date.now();
      await pMap(
        tasks,
        detectJamForCombo,
        4,
        {
          onEach: (out) => {
            if (runId !== currentRunId) return;
            upsertSection(out, runId);
            completed++;
            if (out.na) naCombos++;
            else if (out.transient) transientCombos++;
            else if ((out.hits?.length || 0) > 0) hitCombos++;
            overall = Math.max(overall, out.maxSeverity || 0);
            updateProgressMeta({ total: tasks.length, completed, hitCombos, naCombos, transientCombos, overall });
          }
        }
      );

      const tookMs = Date.now() - startedAt;

      // Remove stale sections from previous runs
      [...resultsElRef.children].forEach(sec => {
        if (sec.getAttribute && sec.getAttribute('data-run-id') !== String(runId)) {
          resultsElRef.removeChild(sec);
        }
      });

      updateProgressMeta({ total: tasks.length, completed, hitCombos, naCombos, transientCombos, overall, tookMs });
      return { overall, tookMs };
    }

    async function runDetect(force = false, { auto = false } = {}) {
      const dirSel = getDirSelection();
      const svcSel = getSvcSelection();
      const routes = await gatherRoutes();

      if (routes.length === 0) { alert('請輸入至少一個路線編號（例如：276A 或 276A,269C，或輸入 ALL）'); return; }

      const value = $('#routes').value.trim().toUpperCase();
      usingAllRoutes = (value === 'ALL');

      const key = JSON.stringify({ routesKey: usingAllRoutes ? 'ALL' : routes.join(','), dirSel, svcSel });
      if (!force && key === lastQueryKey) { /* same params */ }
      else { const tooLong = routes.join(',').length > 200 || usingAllRoutes; safeSetParamsMulti(routes, dirSel, svcSel, { all: tooLong }); }
      lastQueryKey = key;

      currentRunId++; const runId = currentRunId;

      setBusy(true, { auto });
      try {
        await detectJamMulti({ routes, dirSel, svcSel, runId });
        setFooterUpdated();
      } catch (e) {
        $('#statusArea').style.display = 'block';
        $('#statusBadge').className = 'badge bad';
        $('#statusBadge').textContent = `❌ ${OFFLINE_TEXT}`;
        const msg = (e && e.message) ? e.message : String(e || '未知錯誤');
        $('#metaText').innerHTML = `<span style="color:#b31c1c;">錯誤：${msg}</span>`;
      } finally { setBusy(false, { auto }); }
    }

    function startAutoRefresh() {
      if (autoTimer) clearInterval(autoTimer);
      autoTimer = setInterval(() => runDetect(true, { auto: true }), 30000);
    }

    // Load all KMB route codes via API and run both directions
    async function fetchAllRouteCodes(limit = 1000) {
      const j = await fetchJSON(`${API}/route`);
      const list = (j?.data || []).map(x => (x.route || '').toUpperCase()).filter(Boolean);
      const uniq = [...new Set(list)].sort((a, b) => a.localeCompare(b, 'zh-HK', { numeric: true }));
      return uniq.slice(0, limit);
    }

    // Events
    $('#checkBtn').addEventListener('click', () => { runDetect(); startAutoRefresh(); });
    $('#refreshBtn').addEventListener('click', () => runDetect(true));
    $('#shareBtn').addEventListener('click', async () => {
      const dirSel = getDirSelection(); const svcSel = getSvcSelection();
      const value = $('#routes').value.trim().toUpperCase();
      const routes = (value === 'ALL') ? ['ALL'] : normalizeRoutes(value);
      const tooLong = routes.join(',').length > 200 || value === 'ALL';
      const url = new URL(window.location.href);
      url.searchParams.set('route', tooLong ? 'ALL' : routes.join(','));
      url.searchParams.set('bound', dirSel);
      url.searchParams.set('serviceType', svcSel.join(','));
      const shareUrl = url.toString();
      try {
        if (navigator.share) await navigator.share({ title: 'KMB Bus Service Update', url: shareUrl });
        else if (navigator.clipboard) { await navigator.clipboard.writeText(shareUrl); alert('已複製分享連結到剪貼簿'); }
        else { prompt('複製以下連結：', shareUrl); }
      } catch {}
    });

    $('#allRoutesBtn').addEventListener('click', async () => {
      if (!confirm('此操作會抓取全港所有九巴路線並以「兩方向」分析，可能非常耗時並消耗流量。是否繼續？')) return;
      $('#routes').value = 'ALL';
      [...$('#dirChips').children].forEach(c => c.classList.remove('active'));
      const bothEl = $('#dirChips').querySelector('.chip[data-value="both"]');
      if (bothEl) bothEl.classList.add('active');
      await runDetect(true);
      startAutoRefresh();
    });

    // Init
    (function init() {
      setActive($('#dirChips .chip[data-value="outbound"]'), true);
      setActive($('#svcChips .chip[data-value="1"]'), true);
      setFromParams();
      const initial = (getParam('route') || '').trim().toUpperCase();
      if (initial) {
        if (initial === 'ALL') $('#routes').value = 'ALL';
        runDetect(false);
        startAutoRefresh();
      }
    })();
  </script>
</body>
</html>
