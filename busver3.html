<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <title>MTR PIDS Bus Split-Screen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body {
        margin: 0;
        background: #fff;
      }
      .split-section {
        width: 100vw;
        min-height: 50vh;
        padding: 0;
        border: none;
        overflow: hidden;
        box-sizing: border-box;
      }
      .pids-wrapper {
        max-width: 100%;
        margin: 0 auto;
        padding: 0;
      }
      .header {
        background: #003d6b;
        color: #fff;
        padding: 0 36px;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-family: Arial, sans-serif;
        font-size: 40px;
        font-weight: bold;
        letter-spacing: .5px;
      }
      .header .weather {
          display: flex;
          align-items: center;
          gap: 18px;
          font-size: 38px;
      }
      .header .clock {
          font-family: Arial, sans-serif;
          font-size: 44px;
          font-weight: bold;
      }
      .eta-list {
        margin: 0;
        padding: 0;
        list-style: none;
      }
      .eta-row {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 26px 0 24px 40px;
        border-bottom: 2px solid #222;
        font-family: 'Noto Serif TC', 'Times New Roman', serif;
        background: #fff;
        min-height: 90px;
      }
      .eta-row.even {
        background: #d7eff8;
      }
      .eta-route {
        flex: 0 0 120px;
        font-size: 48px;
        font-weight: bold;
        color: #000;
        margin-right: 40px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      .eta-route-number {
        font-size: 48px;
        font-weight: bold;
        color: #000;
      }
      .eta-route-station {
        font-size: 18px;
        font-weight: 400;
        color: #666;
        margin-top: 2px;
        line-height: 1.2;
      }
      .eta-dest {
        flex: 1.5 1 0;
        font-size: 48px;
        letter-spacing: 2px;
        line-height: 1;
        font-weight: 400;
        color: #000;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .eta-times {
        flex: 0 0 600px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        margin-right: 40px;
        gap: 20px;
      }
      .eta-time-block {
        text-align: center;
        min-width: 160px;
      }
      .eta-min-value {
        font-size: 64px;
        font-weight: 700;
        font-family: Arial, sans-serif;
        color: #111;
        letter-spacing: 2px;
        display: block;
      }
      .eta-min-text {
        font-size: 32px;
        font-weight: 400;
        color: #111;
        letter-spacing: .5px;
        line-height: 1;
        display: inline;
      }
      .eta-actual-time {
        font-size: 28px;
        font-weight: 400;
        color: #666;
        margin-top: 4px;
        font-family: Arial, sans-serif;
        letter-spacing: 1px;
      }
      .eta-remark {
        margin-top: 8px;
        padding: 2px 12px;
        border-radius: 4px;
        background: #e5f1fb;
        color: #2176ae;
        font-size: 24px;
        font-family: Arial, sans-serif;
        display: inline-block;
        font-weight: 400;
      }
      .eta-remark.alert {
        background: #fee;
        color: #b31c1c;
        animation: flash 1.5s ease-in-out infinite;
      }
      @keyframes flash {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .no-eta {
        color: #999;
        font-size: 48px;
      }
      .loading, .error { 
        text-align: center; 
        color: #555; 
        font-size: 32px;
        padding: 60px 0 0 0;
      }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="header">
    <div class="weather" id="weather-display">
      <span id="weather-icon">‚òÅÔ∏è</span> 
      <span id="weather-temp">--¬∞C</span>
    </div>
    <span class="clock" id="main-clock">--:--:--</span>
  </div>
  <div id="split-top" class="split-section"></div>
  <div id="split-bottom" class="split-section"></div>
  <script>
    // -------- URL PARAMS --------
    function getQueryParam(name, fallback) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name) || fallback;
    }
    const topStop = getQueryParam('top_id', 'B10F5697E4DA810B');
    const bottomStop = getQueryParam('bottom_id', 'F97A667725CDEB82');
    const onlyShowRoute = getQueryParam('onlyshowroute', null);
    const hideRoute = getQueryParam('hideroute', null);
    const showStopName = getQueryParam('showstopname', 'on') === 'on';

    // -------- WEATHER API --------
    function mapWeatherIcon(code) {
      const iconMap = {
        50: '‚òÄÔ∏è', 51: 'üå§Ô∏è', 52: 'üå§Ô∏è', 53: 'üå§Ô∏è', 54: 'üå§Ô∏è',
        60: '‚òÅÔ∏è', 61: '‚òÅÔ∏è', 62: '‚õÖ', 63: 'üåßÔ∏è', 64: 'üåßÔ∏è',
        65: '‚õàÔ∏è', 70: 'üåßÔ∏è', 71: 'üåßÔ∏è', 72: 'üåßÔ∏è',
        80: 'üåßÔ∏è', 81: '‚õàÔ∏è', 82: '‚õàÔ∏è', 83: '‚õàÔ∏è'
      };
      return iconMap[code] || '‚òÅÔ∏è';
    }

    async function updateWeather() {
      try {
        const response = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc');
        const data = await response.json();
        
        // Find ‰πùÈæçÂüé temperature
        const kowloonCity = data.temperature.data.find(station => station.place === '‰πùÈæçÂüé');
        if (kowloonCity) {
          document.getElementById('weather-temp').textContent = `${kowloonCity.value}¬∞C`;
        }
        
        // Update weather icon
        if (data.icon && data.icon[0]) {
          document.getElementById('weather-icon').textContent = mapWeatherIcon(data.icon[0]);
        }
      } catch(e) {
        console.error('Weather fetch error:', e);
        document.getElementById('weather-temp').textContent = '--¬∞C';
        document.getElementById('weather-icon').textContent = '‚òÅÔ∏è';
      }
    }

    // -------- STOP INFO API --------
    async function fetchStopInfo(stop_id) {
      try {
        let res = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop/${stop_id}`);
        let json = await res.json();
        if (json.data && json.data.name_tc)
          return json.data.name_tc;
      } catch {}
      return "Â∑¥Â£´Á´ô " + stop_id;
    }

    // -------- COMPONENTS --------
    function pad2(n) {
      return n > 9 ? n : '0' + n;
    }

    function getClockString() {
      const d = new Date();
      let h = d.getHours();
      const m = d.getMinutes();
      const s = d.getSeconds();
      // Convert to 12-hour format
      h = h % 12 || 12;
      return h + ':' + pad2(m) + ':' + pad2(s);
    }

    function formatETA(etaString) {
      if (!etaString) return { minutes: '--', time: '--' };
      
      const etaTime = new Date(etaString);
      const now = new Date();
      const minutes = Math.max(0, Math.floor((etaTime - now) / 60000));
      
      // 12-hour format without AM/PM
      let h = etaTime.getHours();
      const m = etaTime.getMinutes();
      h = h % 12 || 12;
      const timeStr = h + ':' + pad2(m);
      
      return { 
        minutes: isNaN(minutes) ? '--' : minutes, 
        time: timeStr 
      };
    }

    function makeETAList(etaData, stopName) {
      // Filter by route parameters
      let filteredData = etaData;
      if (onlyShowRoute) {
        const routesToShow = onlyShowRoute.split(',').map(r => r.trim().toUpperCase());
        filteredData = filteredData.filter(x => routesToShow.includes(x.route.toUpperCase()));
      }
      if (hideRoute) {
        const routesToHide = hideRoute.split(',').map(r => r.trim().toUpperCase());
        filteredData = filteredData.filter(x => !routesToHide.includes(x.route.toUpperCase()));
      }
      
      // Group by route + destination
      let groups = {};
      filteredData.forEach(x => {
        if (!x.eta) return;
        const key = `${x.route}-${x.dest_tc}`;
        if (!groups[key]) {
          groups[key] = {
            route: x.route,
            dest: x.dest_tc,
            etas: []
          };
        }
        groups[key].etas.push(x);
      });

      // Sort to show 269C first
      const sortedGroups = Object.values(groups).sort((a, b) => {
        if (a.route === '269C' && b.route !== '269C') return -1;
        if (a.route !== '269C' && b.route === '269C') return 1;
        return a.route.localeCompare(b.route);
      });

      let rows = [];
      sortedGroups.forEach((group, i) => {
        // Sort ETAs by time
        group.etas.sort((a, b) => new Date(a.eta) - new Date(b.eta));
        
        // Show up to 3 ETAs
        const etaTimes = [];
        for (let j = 0; j < 3; j++) {
          if (group.etas[j]) {
            const eta = formatETA(group.etas[j].eta);
            const remark = group.etas[j].rmk_tc && group.etas[j].rmk_tc !== 'ÂéüÂÆöÁè≠Ê¨°' 
              ? `<div class="eta-remark alert">${group.etas[j].rmk_tc}</div>`
              : (group.etas[j].rmk_tc === 'ÂéüÂÆöÁè≠Ê¨°' ? '<div class="eta-remark">ÂéüÂÆöÁè≠Ê¨°</div>' : '');
            
            etaTimes.push(`
              <div class="eta-time-block">
                <span class="eta-min-value">${eta.minutes}</span><span class="eta-min-text">ÂàÜÈêò</span>
                <div class="eta-actual-time">${eta.time}</div>
                ${remark}
              </div>
            `);
          } else {
            etaTimes.push(`
              <div class="eta-time-block">
                <span class="no-eta">--</span>
              </div>
            `);
          }
        }
        
        rows.push(`
          <li class="eta-row${i % 2 ? ' even' : ''}">
            <div class="eta-route">
              <span class="eta-route-number">${group.route}</span>
              ${showStopName ? `<span class="eta-route-station">${stopName}</span>` : ''}
            </div>
            <span class="eta-dest">${group.dest}</span>
            <div class="eta-times">
              ${etaTimes.join('')}
            </div>
          </li>
        `);
      });

      if (rows.length === 0) return `<div class="loading">Êö´ÁÑ°Áè≠Ê¨°</div>`;
      return `<ul class="eta-list">${rows.join('')}</ul>`;
    }

    // Cache for stop names
    const stopNameCache = {};

    // -------- API + UI wiring --------
    async function renderSplitScreen(stopId, selector) {
      const container = document.querySelector(selector);
      if (!container.hasChildNodes() || container.querySelector('.loading, .error')) {
        container.innerHTML = `<div class="loading">ËºâÂÖ•‰∏≠...</div>`;
      }
      
      // Fetch stop name if not cached
      if (!stopNameCache[stopId]) {
        stopNameCache[stopId] = await fetchStopInfo(stopId);
      }
      const stopName = stopNameCache[stopId];
      
      const url = `https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/${stopId}`;
      try {
        const resp = await fetch(url);
        const data = await resp.json();
        const visible = (data.data || []).filter(x => x.eta);
        
        if (visible.length === 0) {
          container.innerHTML = `<div class="loading">Êö´ÁÑ°Áè≠Ê¨°</div>`;
        } else {
          const newContent = makeETAList(visible, stopName);
          // Update existing rows instead of full replace to prevent flash
          const existingList = container.querySelector('.eta-list');
          if (existingList) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newContent;
            const newList = tempDiv.querySelector('.eta-list');
            if (newList) {
              existingList.innerHTML = newList.innerHTML;
            }
          } else {
            container.innerHTML = newContent;
          }
        }
      } catch(e) {
        container.innerHTML = `<div class="error">ËºâÂÖ•Â§±Êïó</div>`;
      }
    }

    // Auto-refresh + clock update
    async function doAllUpdates() {
      await renderSplitScreen(topStop, '#split-top');
      await renderSplitScreen(bottomStop, '#split-bottom');
    }

    // Initialize
    updateWeather();
    doAllUpdates();
    
    // Intervals
    setInterval(doAllUpdates, 10000); // Bus data every 10 seconds
    setInterval(updateWeather, 60000); // Weather every 60 seconds
    
    // Initialize and update main clock
    document.getElementById('main-clock').textContent = getClockString();
    setInterval(() => {
      document.getElementById('main-clock').textContent = getClockString();
    }, 1000);
  </script>
</body>
</html>
