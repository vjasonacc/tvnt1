<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <title>MTR PIDS Bus Split-Screen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body {
        margin: 0;
        background: #fff;
      }
      .split-section {
        width: 100vw;
        min-height: 50vh;
        padding: 0;
        border: none;
        overflow: hidden;
        box-sizing: border-box;
      }
      .pids-wrapper {
        max-width: 100%;
        margin: 0 auto;
        padding: 0;
      }
      .header {
        background: #003d6b;
        color: #fff;
        padding: 0 36px;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-family: Arial, sans-serif;
        font-size: 40px;
        font-weight: bold;
        letter-spacing: .5px;
      }
      .header .weather {
          display: flex;
          align-items: center;
          gap: 18px;
          font-size: 38px;
      }
      .header .clock {
          font-family: Arial, sans-serif;
          font-size: 44px;
          font-weight: bold;
      }
      .eta-list {
        margin: 0;
        padding: 0;
        list-style: none;
      }
      .eta-row {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 26px 0 24px 60px;
        border-bottom: 2px solid #222;
        font-family: 'Noto Serif TC', 'Times New Roman', serif;
        background: #fff;
        min-height: 90px;
      }
      .eta-row.even {
        background: #d7eff8;
      }
      .eta-dest {
        flex: 2.1 1 0;
        font-size: 50px;
        letter-spacing: 2px;
        line-height: 1;
        font-weight: 400;
        color: #000;
      }
      .eta-eta {
        flex: 0 0 140px;
        display: flex;
        justify-content: flex-end;
        align-items: baseline;
        margin-right: 40px;
      }
      .eta-min-value {
        font-size: 72px;
        font-weight: 700;
        font-family: Arial, sans-serif;
        color: #111;
        letter-spacing: 2px;
      }
      .eta-min-text {
        font-size: 40px;
        font-weight: 400;
        margin-left: 6px;
        color: #111;
        letter-spacing: .5px;
        line-height: 1;
      }
      .eta-remark {
        margin-left: 20px;
        padding: 3px 18px;
        border-radius: 4px;
        background: #e5f1fb;
        color: #2176ae;
        font-size: 32px;
        font-family: Arial, sans-serif;
        display: inline-block;
        font-weight: 400;
        vertical-align: middle;
      }
      .eta-remark.alert {
        background: #fee;
        color: #b31c1c;
        animation: flash 1.5s ease-in-out infinite;
      }
      @keyframes flash {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .loading, .error { 
        text-align: center; 
        color: #555; 
        font-size: 32px;
        padding: 60px 0 0 0;
      }
    </style>
    <!-- Noto Serif TC font for authentic CJK look (Google Fonts CDN) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div id="split-top" class="split-section"></div>
  <div id="split-bottom" class="split-section"></div>
  <script>
    // -------- URL PARAMS --------
    function getQueryParam(name, fallback) {
      // Accept both ?key=, ?key and multistop fallback
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name) || fallback;
    }
    // Default: top = B10F5697E4DA810B, bottom = F97A667725CDEB82
    const topStop = getQueryParam('top_id', 'B10F5697E4DA810B');
    const bottomStop = getQueryParam('bottom_id', 'F97A667725CDEB82');

    // -------- COMPONENTS --------
    function makeHeader(weather, temp, time) {
      // temp and weather are optional: photo has ☁️ 29°C left
      return `
        <div class="header">
          <div class="weather"><span>☁️</span> <span>${temp ?? '29°C'}</span></div>
          <span class="clock" id="clock-${Math.random().toString(36).slice(2,6)}">${time}</span>
        </div>
      `;
    }
    function pad2(n) {
      return n > 9 ? n : '0' + n;
    }
    function getClockString() {
      const d = new Date();
      return pad2(d.getHours()) + ':' + pad2(d.getMinutes());
    }
    // Accepts API data array, renders as your image
    function makeETAList(etaData) {
      // group by destination
      let groups = {};
      etaData.forEach(x => {
        if (!x.eta) return; // skip missing ETA
        if (!groups[x.dest_tc]) groups[x.dest_tc] = [];
        groups[x.dest_tc].push(x);
      });
      let rows = [];
      Object.entries(groups).forEach(([dest, arr], i) => {
        // Sort ETA ascending, skip if no ETA at all for this dest
        arr.sort((a,b) => new Date(a.eta)-new Date(b.eta));
        arr.forEach((etaInfo, j) => {
          // Only show up to 2 arrivals per dest as in example
          if (j > 1) return;
          let min = '--';
          if (etaInfo.eta) {
            let minInt = Math.max(0, Math.floor((new Date(etaInfo.eta) - new Date())/60000));
            min = isNaN(minInt) ? '--' : minInt;
          }
          // 繁 remark
          let remark = '';
          if (etaInfo.rmk_tc) {
            remark = etaInfo.rmk_tc === '原定班次'
              ? `<span class="eta-remark">原定班次</span>`
              : `<span class="eta-remark alert">${etaInfo.rmk_tc}</span>`;
          }
          rows.push(`
            <li class="eta-row${ ((i+j)%2)?' even':'' }">
              <span class="eta-dest">${dest}</span>
              <span class="eta-eta">
                <span class="eta-min-value">${min}</span>
                <span class="eta-min-text">分鐘</span>
                ${remark}
              </span>
            </li>
          `);
        });
      });
      if (rows.length === 0) return `<div class="loading">暫無班次</div>`;
      return `<ul class="eta-list">${rows.join('')}</ul>`;
    }
    // -------- API + UI wiring --------
    async function renderSplitScreen(stopId, selector) {
      document.querySelector(selector).innerHTML = makeHeader('☁️', '29°C', getClockString()) + `<div class="loading">載入中...</div>`;
      // fetch & show
      const url = `https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/${stopId}`;
      try {
        const resp = await fetch(url);
        const data = await resp.json();
        // Group, filter only with current ETA (hide special-hours if no ETAs)
        const visible = (data.data || []).filter(x => x.eta);
        if (visible.length === 0) {
          document.querySelector(selector).innerHTML = makeHeader('☁️', '29°C', getClockString()) + `<div class="loading">暫無班次</div>`;
        } else {
          document.querySelector(selector).innerHTML = makeHeader('☁️', '29°C', getClockString()) + makeETAList(visible);
        }
      } catch(e) {
        document.querySelector(selector).innerHTML = makeHeader('☁️', '29°C', getClockString()) + `<div class="error">載入失敗</div>`;
      }
    }
    // Auto-refresh + clock update
    async function doAllUpdates() {
      await renderSplitScreen(topStop, '#split-top');
      await renderSplitScreen(bottomStop, '#split-bottom');
    }
    doAllUpdates();
    setInterval(doAllUpdates, 10000);
    // Update clock (every 20s to keep clock accurate to minute)
    setInterval(() => {
      document.querySelectorAll('.clock').forEach(c => c.textContent = getClockString());
    }, 20000);
  </script>
</body>
</html>
