<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <title>MTR PIDS Bus Split-Screen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body {
        margin: 0;
        background: #fff;
      }
      .split-section {
        width: 100vw;
        min-height: 50vh;
        padding: 0;
        border: none;
        overflow: hidden;
        box-sizing: border-box;
      }
      .pids-wrapper {
        max-width: 100%;
        margin: 0 auto;
        padding: 0;
      }
      .header {
        background: #003d6b;
        color: #fff;
        padding: 0 36px;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-family: Arial, sans-serif;
        font-size: 40px;
        font-weight: bold;
        letter-spacing: .5px;
      }
      .header .weather {
          display: flex;
          align-items: center;
          gap: 18px;
          font-size: 38px;
      }
      .header .clock {
          font-family: Arial, sans-serif;
          font-size: 44px;
          font-weight: bold;
      }
      /* Mini PIDS Mode - iPhone 7 Plus size adjustments - even smaller */
      body.minipids .header {
        height: 28px;
        padding: 0 12px;
        font-size: 14px;
      }
      body.minipids .header .weather {
        font-size: 12px;
        gap: 6px;
      }
      body.minipids .header .clock {
        font-size: 14px;
      }
      body.minipids .eta-row {
        padding: 8px 0 8px 12px;
        min-height: 40px;
        border-bottom: 1px solid #222;
      }
      body.minipids .eta-route {
        flex: 0 0 50px;
        margin-right: 12px;
      }
      body.minipids .eta-route-number {
        font-size: 16px;
      }
      body.minipids .eta-route-station {
        font-size: 8px;
      }
      body.minipids .eta-dest {
        flex: 1.5 1 0;
        font-size: 15px;
        letter-spacing: 0.5px;
      }
      body.minipids .eta-times {
        flex: 0 0 240px;
        gap: 6px;
        margin-right: 12px;
      }
      body.minipids .eta-time-block {
        min-width: 65px;
      }
      body.minipids .eta-min-value {
        font-size: 20px;
        letter-spacing: 0.5px;
      }
      body.minipids .eta-min-text {
        font-size: 10px;
      }
      body.minipids .eta-actual-time {
        font-size: 9px;
        margin-top: 1px;
      }
      body.minipids .eta-remark {
        font-size: 8px;
        padding: 1px 4px;
        margin-top: 2px;
      }
      body.minipids .no-eta {
        font-size: 16px;
      }
      body.minipids .loading, body.minipids .error {
        font-size: 12px;
        padding: 20px 0 0 0;
      }
      .eta-list {
        margin: 0;
        padding: 0;
        list-style: none;
      }
      .eta-row {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 26px 0 24px 40px;
        border-bottom: 2px solid #222;
        font-family: 'Noto Serif TC', 'Times New Roman', serif;
        background: #fff;
        min-height: 90px;
      }
      .eta-row.even {
        background: #d7eff8;
      }
      .eta-route {
        flex: 0 0 120px;
        font-size: 48px;
        font-weight: bold;
        color: #000;
        margin-right: 40px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      .eta-route-number {
        font-size: 48px;
        font-weight: bold;
        color: #000;
      }
      .eta-route-station {
        font-size: 18px;
        font-weight: 400;
        color: #666;
        margin-top: 2px;
        line-height: 1.2;
      }
      .eta-dest {
        flex: 2.5 1 0;
        font-size: 48px;
        letter-spacing: 2px;
        line-height: 1;
        font-weight: 400;
        color: #000;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: none;
      }
      .eta-times {
        flex: 0 0 600px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        margin-right: 40px;
        gap: 20px;
      }
      .eta-time-block {
        text-align: center;
        min-width: 160px;
      }
      .eta-min-value {
        font-size: 64px;
        font-weight: 700;
        font-family: Arial, sans-serif;
        color: #111;
        letter-spacing: 2px;
        display: block;
      }
      .eta-min-text {
        font-size: 32px;
        font-weight: 400;
        color: #111;
        letter-spacing: .5px;
        line-height: 1;
        display: inline;
      }
      .eta-actual-time {
        font-size: 28px;
        font-weight: 400;
        color: #666;
        margin-top: 4px;
        font-family: Arial, sans-serif;
        letter-spacing: 1px;
      }
      .eta-remark {
        margin-top: 8px;
        padding: 2px 12px;
        border-radius: 4px;
        background: #e5f1fb;
        color: #2176ae;
        font-size: 24px;
        font-family: Arial, sans-serif;
        display: inline-block;
        font-weight: 400;
      }
      .eta-remark.alert {
        background: #fee;
        color: #b31c1c;
        animation: flash 1.5s ease-in-out infinite;
      }
      @keyframes flash {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .no-eta {
        color: #999;
        font-size: 48px;
      }
      .loading, .error { 
        text-align: center; 
        color: #555; 
        font-size: 32px;
        padding: 60px 0 0 0;
      }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="header">
    <div class="weather" id="weather-display">
      <span id="weather-icon">â˜ï¸</span> 
      <span id="weather-temp">--Â°C</span>
    </div>
    <span class="clock" id="main-clock">--:--:--</span>
  </div>
  <div id="split-top" class="split-section"></div>
  <div id="split-bottom" class="split-section"></div>
  <script>
    // -------- URL PARAMS --------
    function getQueryParam(name, fallback) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name) || fallback;
    }
    const topStop = getQueryParam('top_id', 'A00D00FC2F4F8400'); // default
// B10F5697E4DA810B is kmb station é Œæ£‹é–£ (TN271) 269c ok
      // A00D00FC2F4F8400 is for kmb station 276a 
    const bottomStop = getQueryParam('bottom_id', 'B10F5697E4DA810B'); // default
    const onlyShowRoute = getQueryParam('onlyshowroute', null);
    const hideRoute = getQueryParam('hideroute', null); // hide route
    const showStopName = getQueryParam('showstopname', 'on') === 'on'; //// default show station name
    const displayMode = getQueryParam('mode', 'normal'); // normal or minipids
    const showTrafficNews = getQueryParam('app1trafficnews', 'false') === 'true';
    const trafficRoute = getQueryParam('trafficroute', '276A'); // default route for traffic news
    const showHome = getQueryParam('home', null) === 'true';

    // -------- WEATHER API --------
    function mapWeatherIcon(code) {
      const iconMap = {
        50: 'â˜€ï¸', 51: 'ğŸŒ¤ï¸', 52: 'ğŸŒ¤ï¸', 53: 'ğŸŒ¤ï¸', 54: 'ğŸŒ¤ï¸',
        60: 'â˜ï¸', 61: 'â˜ï¸', 62: 'â›…', 63: 'ğŸŒ§ï¸', 64: 'ğŸŒ§ï¸',
        65: 'â›ˆï¸', 70: 'ğŸŒ§ï¸', 71: 'ğŸŒ§ï¸', 72: 'ğŸŒ§ï¸',
        80: 'ğŸŒ§ï¸', 81: 'â›ˆï¸', 82: 'â›ˆï¸', 83: 'â›ˆï¸'
      };
      return iconMap[code] || 'â˜ï¸';
    }

    async function updateWeather() {
      try {
        const response = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc');
        const data = await response.json();
        
        // Find ä¹é¾åŸ temperature
        const kowloonCity = data.temperature.data.find(station => station.place === 'ä¹é¾åŸ');
        if (kowloonCity) {
          document.getElementById('weather-temp').textContent = `${kowloonCity.value}Â°C`;
        }
        
        // Update weather icon
        if (data.icon && data.icon[0]) {
          document.getElementById('weather-icon').textContent = mapWeatherIcon(data.icon[0]);
        }
      } catch(e) {
        console.error('Weather fetch error:', e);
        document.getElementById('weather-temp').textContent = '--Â°C';
        document.getElementById('weather-icon').textContent = 'â˜ï¸';
      }
    }

    // -------- STOP INFO API --------
    async function fetchStopInfo(stop_id) {
      try {
        let res = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop/${stop_id}`);
        let json = await res.json();
        if (json.data && json.data.name_tc)
          return json.data.name_tc;
      } catch {}
      return "å·´å£«ç«™ " + stop_id;
    }

    // -------- COMPONENTS --------
    function pad2(n) {
      return n > 9 ? n : '0' + n;
    }

    function getClockString() {
      const d = new Date();
      let h = d.getHours();
      const m = d.getMinutes();
      const s = d.getSeconds();
      // Convert to 12-hour format
      h = h % 12 || 12;
      return h + ':' + pad2(m) + ':' + pad2(s);
    }

    function formatETA(etaString) {
      if (!etaString) return { minutes: '--', time: '--' };
      
      const etaTime = new Date(etaString);
      const now = new Date();
      const minutes = Math.max(0, Math.floor((etaTime - now) / 60000));
      
      // 12-hour format without AM/PM
      let h = etaTime.getHours();
      const m = etaTime.getMinutes();
      h = h % 12 || 12;
      const timeStr = h + ':' + pad2(m);
      
      return { 
        minutes: isNaN(minutes) ? '--' : minutes, 
        time: timeStr 
      };
    }

    function makeETAList(etaData, stopName) {
      // Filter by route parameters
      let filteredData = etaData;
      if (onlyShowRoute) {
        const routesToShow = onlyShowRoute.split(',').map(r => r.trim().toUpperCase());
        filteredData = filteredData.filter(x => routesToShow.includes(x.route.toUpperCase()));
      }
      if (hideRoute) {
        const routesToHide = hideRoute.split(',').map(r => r.trim().toUpperCase());
        filteredData = filteredData.filter(x => !routesToHide.includes(x.route.toUpperCase()));
      }
      
      // Group by route + destination
      let groups = {};
      filteredData.forEach(x => {
        if (!x.eta) return;
        const key = `${x.route}-${x.dest_tc}`;
        if (!groups[key]) {
          groups[key] = {
            route: x.route,
            dest: x.dest_tc,
            etas: []
          };
        }
        groups[key].etas.push(x);
      });

      // Sort to show 269C and 269S first
      const sortedGroups = Object.values(groups).sort((a, b) => {
        const priorityRoutes = ['269C', '269S'];
        const aIsPriority = priorityRoutes.includes(a.route);
        const bIsPriority = priorityRoutes.includes(b.route);
        
        if (aIsPriority && !bIsPriority) return -1;
        if (!aIsPriority && bIsPriority) return 1;
        return a.route.localeCompare(b.route);
      });

      let rows = [];
      sortedGroups.forEach((group, i) => {
        // Sort ETAs by time
        group.etas.sort((a, b) => new Date(a.eta) - new Date(b.eta));
        
        // Show up to 3 ETAs
        const etaTimes = [];
        for (let j = 0; j < 3; j++) {
          if (group.etas[j]) {
            const eta = formatETA(group.etas[j].eta);
            const remark = group.etas[j].rmk_tc && group.etas[j].rmk_tc !== 'åŸå®šç­æ¬¡' 
              ? `<div class="eta-remark alert">${group.etas[j].rmk_tc}</div>`
              : (group.etas[j].rmk_tc === 'åŸå®šç­æ¬¡' ? '<div class="eta-remark">åŸå®šç­æ¬¡</div>' : '');
            
            etaTimes.push(`
              <div class="eta-time-block">
                <span class="eta-min-value">${eta.minutes}</span><span class="eta-min-text">åˆ†é˜</span>
                <div class="eta-actual-time">${eta.time}</div>
                ${remark}
              </div>
            `);
          } else {
            etaTimes.push(`
              <div class="eta-time-block">
                <span class="no-eta">--</span>
              </div>
            `);
          }
        }
        
        rows.push(`
          <li class="eta-row${i % 2 ? ' even' : ''}">
            <div class="eta-route">
              <span class="eta-route-number">${group.route}</span>
              ${showStopName ? `<span class="eta-route-station">${stopName}</span>` : ''}
            </div>
            <span class="eta-dest">${group.dest}</span>
            <div class="eta-times">
              ${etaTimes.join('')}
            </div>
          </li>
        `);
      });

      if (rows.length === 0) return `<div class="loading">æš«ç„¡ç­æ¬¡</div>`;
      return `<ul class="eta-list">${rows.join('')}</ul>`;
    }

    // Cache for stop names
    const stopNameCache = {};

    // -------- API + UI wiring --------
    async function renderSplitScreen(stopId, selector) {
      const container = document.querySelector(selector);
      if (!container.hasChildNodes() || container.querySelector('.loading, .error')) {
        container.innerHTML = `<div class="loading">è¼‰å…¥ä¸­...</div>`;
      }
      
      // Fetch stop name if not cached
      if (!stopNameCache[stopId]) {
        stopNameCache[stopId] = await fetchStopInfo(stopId);
      }
      const stopName = stopNameCache[stopId];
      
      const url = `https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/${stopId}`;
      try {
        const resp = await fetch(url);
        const data = await resp.json();
        const visible = (data.data || []).filter(x => x.eta);
        
        if (visible.length === 0) {
          container.innerHTML = `<div class="loading">æš«ç„¡ç­æ¬¡</div>`;
        } else {
          const newContent = makeETAList(visible, stopName);
          // Update existing rows instead of full replace to prevent flash
          const existingList = container.querySelector('.eta-list');
          if (existingList) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newContent;
            const newList = tempDiv.querySelector('.eta-list');
            if (newList) {
              existingList.innerHTML = newList.innerHTML;
            }
          } else {
            container.innerHTML = newContent;
          }
        }
      } catch(e) {
        container.innerHTML = `<div class="error">è¼‰å…¥å¤±æ•—</div>`;
      }
    }

    // Auto-refresh + clock update
    async function doAllUpdates() {
      await renderSplitScreen(topStop, '#split-top');
      await renderSplitScreen(bottomStop, '#split-bottom');
    }

    // -------- TRAFFIC NEWS FEATURE (ALL STATIONS ETA VIEW) --------
    async function fetchRouteAllStationsETA() {
      const stationETAs = [];
      
      try {
        // Use trafficRoute parameter (default: 276A)
        const routeCode = trafficRoute.toUpperCase();
        
        // Fetch both INBOUND and OUTBOUND directions
        const directions = ['inbound', 'outbound'];
        
        for (const direction of directions) {
          // Fetch route info for this direction
          const routeResp = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/route/${routeCode}/${direction}/1`);
          const routeData = await routeResp.json();
          
          if (!routeData.data) continue; // Skip if direction doesn't exist
          
          const route = routeData.data;
          const directionLabel = direction === 'outbound' ? 'å¾€' : 'è¿”';
          
          // Fetch all stops for this route and direction
          const routeStopsResp = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/route-stop/${routeCode}/${direction}/1`);
          const routeStopsData = await routeStopsResp.json();
          const stops = routeStopsData.data || [];
          
          console.log(`Found ${stops.length} stops for route ${routeCode} ${direction}`);
          
          // Fetch ETA for each station
          for (let i = 0; i < stops.length; i++) {
            const stop = stops[i];
            
            // Get stop name
            const stopInfoResp = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop/${stop.stop}`);
            const stopInfo = await stopInfoResp.json();
            const stopName = stopInfo.data?.name_tc || 'æœªçŸ¥ç«™é»';
            
            // Get ETAs for this stop and route
            const etaResp = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/eta/${stop.stop}/${routeCode}/1`);
            const etaData = await etaResp.json();
            
            const routeETAs = (etaData.data || []).filter(x => x.eta && x.dir === direction.substring(0, 1).toUpperCase());
            
            stationETAs.push({
              route: routeCode,
              dest: `${directionLabel}${route.dest_tc}`,
              direction: directionLabel,
              seq: stop.seq,
              stopName: stopName,
              etas: routeETAs.slice(0, 3), // Next 3 buses
              hasAlert: routeETAs.some(x => x.rmk_tc && x.rmk_tc !== 'åŸå®šç­æ¬¡')
            });
          }
        }
        
        if (stationETAs.length === 0) {
          return [{error: `æ‰¾ä¸åˆ°è·¯ç·š ${routeCode}`}];
        }
      } catch (e) {
        console.error('Traffic news fetch error:', e);
        return [{error: `è¼‰å…¥å¤±æ•—: ${e.message}`}];
      }
      
      return stationETAs;
    }

    function renderAllStationsETA(stations) {
      const container = document.querySelector('#split-bottom');
      container.style.display = 'block';
      
      if (stations.length === 0 || stations[0]?.error) {
        container.innerHTML = `
          <div style="padding: 40px; text-align: center; font-size: 24px; color: #555;">
            <div>è¼‰å…¥å¤±æ•—</div>
            <div style="font-size: 16px; color: #999; margin-top: 10px;">${stations[0]?.error || 'æœªçŸ¥éŒ¯èª¤'}</div>
          </div>
        `;
        return;
      }
      
      let html = '<ul class="eta-list">';
      stations.forEach((station, i) => {
        const etaTimes = [];
        for (let j = 0; j < 3; j++) {
          if (station.etas[j]) {
            const eta = formatETA(station.etas[j].eta);
            const remarkText = station.etas[j].rmk_tc;
            let remark = '';
            if (remarkText) {
              if (remarkText === 'åŸå®šç­æ¬¡') {
                remark = `<div class="eta-remark">åŸå®šç­æ¬¡</div>`;
              } else {
                remark = `<div class="eta-remark alert">${remarkText}</div>`;
              }
            }
            
            etaTimes.push(`
              <div class="eta-time-block">
                <span class="eta-min-value">${eta.minutes}</span><span class="eta-min-text">åˆ†é˜</span>
                <div class="eta-actual-time">${eta.time}</div>
                ${remark}
              </div>
            `);
          } else {
            etaTimes.push(`
              <div class="eta-time-block">
                <span class="no-eta">--</span>
              </div>
            `);
          }
        }
        
        html += `
          <li class="eta-row${i % 2 ? ' even' : ''}">
            <div class="eta-route">
              <span class="eta-route-number">${station.route}</span>
              <span class="eta-route-station">${station.seq}. ${station.stopName}</span>
            </div>
            <span class="eta-dest">${station.dest}</span>
            <div class="eta-times">
              ${etaTimes.join('')}
            </div>
          </li>
        `;
      });
      html += '</ul>';
      
      container.innerHTML = html;
    }

    async function showTrafficNewsView() {
      const container = document.querySelector('#split-bottom');
      container.style.display = 'block';
      container.innerHTML = `<div class="loading">æ­£åœ¨è¼‰å…¥è·¯ç·šè³‡æ–™...</div>`;
      
      updateWeather();
      
      const stations = await fetchRouteAllStationsETA();
      renderAllStationsETA(stations);
      
      // Refresh every 30 seconds
      setInterval(async () => {
        const stations = await fetchRouteAllStationsETA();
        renderAllStationsETA(stations);
      }, 30000);
      
      // Update weather
      setInterval(updateWeather, 60000);
    }

    // Apply display mode
    if (displayMode === 'minipids') {
      document.body.classList.add('minipids');
    }

    // -------- HOME PAGE FEATURE --------
    function showHomePage() {
      document.getElementById('split-top').style.display = 'none';
      document.getElementById('split-bottom').style.display = 'block';
      
      const container = document.querySelector('#split-bottom');
      container.innerHTML = `
        <div style="padding: 40px; max-width: 800px; margin: 0 auto; font-family: Arial, sans-serif;">
          <h1 style="color: #003d6b; margin-bottom: 30px;">MTR PIDS å·´å£«åˆ°ç«™é¡¯ç¤ºç³»çµ±</h1>
          
          <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <h2 style="color: #003d6b; font-size: 20px; margin-bottom: 15px;">åŸºç¤ç¶²å€</h2>
            <input type="text" id="base-url" value="https://vjasonacc.github.io/tvnt1/busver3.html" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 14px;">
            
            <h2 style="color: #003d6b; font-size: 20px; margin-bottom: 15px;">é¸æ“‡é¡¯ç¤ºæ¨¡å¼</h2>
            <select id="mode-select" style="width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 15px;">
              <option value="normal">æ­£å¸¸æ¨¡å¼ï¼ˆå¤§è¢å¹•ï¼‰</option>
              <option value="minipids">è¿·ä½ æ¨¡å¼ï¼ˆå°è¢å¹•ï¼‰</option>
            </select>
            
            <h2 style="color: #003d6b; font-size: 20px; margin-bottom: 15px;">é¸æ“‡åŠŸèƒ½</h2>
            <label style="display: block; margin-bottom: 10px;">
              <input type="radio" name="feature" value="eta" checked> åˆ°ç«™æ™‚é–“é¡¯ç¤ºï¼ˆé›™ç«™é»ï¼‰
            </label>
            <label style="display: block; margin-bottom: 10px;">
              <input type="radio" name="feature" value="traffic"> è·¯ç·šäº¤é€šè³‡è¨Šï¼ˆå…¨ç«™é»ï¼‰
            </label>
          </div>
          
          <div id="eta-config" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h2 style="color: #003d6b; font-size: 20px; margin-bottom: 15px;">åˆ°ç«™æ™‚é–“é…ç½®</h2>
            <label style="display: block; margin-bottom: 10px;">
              ä¸Šæ–¹ç«™é» ID:
              <input type="text" id="top-stop" value="B10F5697E4DA810B" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
            </label>
            <label style="display: block; margin-bottom: 10px;">
              ä¸‹æ–¹ç«™é» ID:
              <input type="text" id="bottom-stop" value="F97A667725CDEB82" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
            </label>
            <label style="display: block; margin-bottom: 10px;">
              åªé¡¯ç¤ºè·¯ç·šï¼ˆé€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚: 269C,269Sï¼‰:
              <input type="text" id="only-routes" placeholder="ç•™ç©ºé¡¯ç¤ºå…¨éƒ¨" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
            </label>
            <label style="display: block; margin-bottom: 10px;">
              éš±è—è·¯ç·šï¼ˆé€—è™Ÿåˆ†éš”ï¼‰:
              <input type="text" id="hide-routes" placeholder="ç•™ç©ºä¸éš±è—" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
            </label>
            <label style="display: block; margin-bottom: 10px;">
              <input type="checkbox" id="show-stopname" checked> é¡¯ç¤ºç«™é»åç¨±
            </label>
          </div>
          
          <div id="traffic-config" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none;">
            <h2 style="color: #003d6b; font-size: 20px; margin-bottom: 15px;">è·¯ç·šäº¤é€šè³‡è¨Šé…ç½®</h2>
            <label style="display: block; margin-bottom: 10px;">
              è·¯ç·šç·¨è™Ÿ:
              <input type="text" id="traffic-route" value="276A" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
            </label>
          </div>
          
          <button id="generate-btn" style="width: 100%; padding: 15px; font-size: 18px; background: #003d6b; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 20px;">
            ç”Ÿæˆç¶²å€
          </button>
          
          <div id="result" style="display: none; background: #e5f1fb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: #003d6b; margin-bottom: 10px;">æ‚¨çš„å°ˆå±¬ç¶²å€ï¼š</h3>
            <input type="text" id="generated-url" readonly style="width: 100%; padding: 10px; border: 1px solid #003d6b; border-radius: 4px; margin-bottom: 10px; font-family: monospace; font-size: 14px;">
            <button id="copy-btn" style="width: 100%; padding: 10px; background: #2176ae; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px;">
              è¤‡è£½ç¶²å€
            </button>
            <button id="open-btn" style="width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
              é–‹å•Ÿç¶²å€
            </button>
          </div>
          
          <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
            <h3 style="color: #856404; margin-bottom: 10px;">ğŸ’¡ ä½¿ç”¨æŒ‡å—</h3>
            <p style="color: #856404; line-height: 1.6; margin: 5px 0;"><strong>iOS Safari:</strong> é»æ“Šã€Œåˆ†äº«ã€â†’ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</p>
            <p style="color: #856404; line-height: 1.6; margin: 5px 0;"><strong>Android Chrome:</strong> é»æ“Šã€Œâ‹®ã€â†’ã€ŒåŠ åˆ°ä¸»ç•«é¢ã€</p>
            <p style="color: #856404; line-height: 1.6; margin: 5px 0;"><strong>é›»è…¦:</strong> æŒ‰ Ctrl+Dï¼ˆMac: Cmd+Dï¼‰åŠ å…¥æ›¸ç±¤</p>
          </div>
        </div>
      `;
      
      // Event listeners
      const featureRadios = document.querySelectorAll('input[name="feature"]');
      const etaConfig = document.getElementById('eta-config');
      const trafficConfig = document.getElementById('traffic-config');
      
      featureRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
          if (e.target.value === 'eta') {
            etaConfig.style.display = 'block';
            trafficConfig.style.display = 'none';
          } else {
            etaConfig.style.display = 'none';
            trafficConfig.style.display = 'block';
          }
        });
      });
      
      document.getElementById('generate-btn').addEventListener('click', () => {
        const mode = document.getElementById('mode-select').value;
        const feature = document.querySelector('input[name="feature"]:checked').value;
        
        const baseUrl = document.getElementById('base-url').value.trim();
        let params = [];
        
        if (mode !== 'normal') {
          params.push(`mode=${mode}`);
        }
        
        if (feature === 'traffic') {
          params.push('app1trafficnews=true');
          const trafficRoute = document.getElementById('traffic-route').value.trim();
          if (trafficRoute) {
            params.push(`trafficroute=${trafficRoute}`);
          }
        } else {
          const topStop = document.getElementById('top-stop').value.trim();
          const bottomStop = document.getElementById('bottom-stop').value.trim();
          if (topStop !== 'B10F5697E4DA810B') {
            params.push(`top_id=${topStop}`);
          }
          if (bottomStop !== 'F97A667725CDEB82') {
            params.push(`bottom_id=${bottomStop}`);
          }
          
          const onlyRoutes = document.getElementById('only-routes').value.trim();
          if (onlyRoutes) {
            params.push(`onlyshowroute=${onlyRoutes}`);
          }
          
          const hideRoutes = document.getElementById('hide-routes').value.trim();
          if (hideRoutes) {
            params.push(`hideroute=${hideRoutes}`);
          }
          
          const showStopname = document.getElementById('show-stopname').checked;
          if (!showStopname) {
            params.push('showstopname=off');
          }
        }
        
        const finalUrl = params.length > 0 ? `${baseUrl}?${params.join('&')}` : baseUrl;
        
        document.getElementById('generated-url').value = finalUrl;
        document.getElementById('result').style.display = 'block';
      });
      
      document.getElementById('copy-btn').addEventListener('click', () => {
        const urlInput = document.getElementById('generated-url');
        urlInput.select();
        document.execCommand('copy');
        alert('ç¶²å€å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
      });
      
      document.getElementById('open-btn').addEventListener('click', () => {
        const url = document.getElementById('generated-url').value;
        window.location.href = url;
      });
    }

    // Traffic News Mode
    if (showHome) {
      showHomePage();
    } else if (showTrafficNews) {
      document.getElementById('split-top').style.display = 'none';
      document.getElementById('split-bottom').style.display = 'none';
      showTrafficNewsView();
    } else {
      // Initialize normal mode
      updateWeather();
      doAllUpdates();
      
      // Intervals
      setInterval(doAllUpdates, 10000); // Bus data every 10 seconds
      setInterval(updateWeather, 60000); // Weather every 60 seconds
    }
    
    // Initialize and update main clock
    document.getElementById('main-clock').textContent = getClockString();
    setInterval(() => {
      document.getElementById('main-clock').textContent = getClockString();
    }, 1000);
  </script>
</body>
</html>
