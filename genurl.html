<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KMB Real-time Arrival One-page Tool</title>
<style>
  body {
    font-family: Arial, "PingFang HK", "Microsoft JhengHei", sans-serif;
    background: #f5f6fa;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    color: #205d1e;
  }
  .container {
    max-width: 600px;
    margin: 36px auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px #ccc;
    padding: 20px 16px 40px;
  }
  h1 {
    font-weight: 700;
    font-size: 1.8rem;
    text-align: center;
    margin-top: 0;
    letter-spacing: 1px;
  }
  label {
    font-weight: 600;
    margin-top: 20px;
    display: block;
    font-size: 1.1rem;
    margin-bottom: 6px;
  }
  input[type="text"] {
    width: 100%;
    font-size: 1rem;
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  .list {
    margin-top: 12px;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f0faf0;
  }
  .list-item {
    padding: 8px 10px;
    cursor: pointer;
    border-bottom: 1px solid #cee7ce;
    font-size: 1.05rem;
  }
  .list-item:hover {
    background: #d7f0d7;
  }
  .route-item {
    background: #e6f7ff;
    margin: 8px 0;
    border-radius: 8px;
    padding: 10px 16px;
    font-weight: 600;
    font-size: 1.1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  button.route-button {
    background: #388e3c;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 7px;
    padding: 6px 14px;
  }
  button.route-button:hover {
    background: #2e7030;
  }
  .url-block {
    margin-top: 20px;
    padding: 14px 18px;
    background: #fcfcf1;
    border-radius: 7px;
    font-family: monospace;
    font-size: 1.05rem;
    user-select: all;
    word-break: break-word;
  }
  .preview-section {
    margin-top: 30px;
    border-top: 2px solid #d4ecd4;
    padding-top: 20px;
  }
  .station-name {
    font-size: 1.3rem;
    font-weight: 800;
    text-align: center;
    margin-bottom: 14px;
  }
  .eta-list {
    margin-top: 12px;
  }
  .eta-item {
    display: flex;
    justify-content: space-between;
    font-size: 1.1rem;
    border-bottom: 1px solid #d7f0d7;
    padding: 10px 12px;
  }
  .eta-item:last-child {
    border-bottom: none;
  }
  .destination {
    font-weight: 700;
    max-width: 70%;
  }
  .time {
    font-weight: 700;
  }
  .time.green {
    color: #388e3c;
  }
  .time.yellow {
    color: #fbc02d;
  }
  .time.red {
    color: #c62828;
  }
  .remark {
    font-size: 0.85rem;
    margin-left: 10px;
    color: #555;
    white-space: nowrap;
  }
  .error {
    margin-top: 20px;
    color: #c62828;
    font-weight: 700;
    text-align: center;
  }
  .footer-clock {
    color: #666;
    text-align: center;
    margin-top: 25px;
    font-size: 0.95rem;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>KMB 即時到站查詢</h1>
    <label for="stopSearch">搜尋巴士站（中/英）</label>
    <input id="stopSearch" type="text" placeholder="輸入巴士站名稱例如 天耀 / Tin Yiu" autocomplete="off" />
    <div id="stopResults" class="list"></div>

    <div id="selectedStopSection" style="display:none;">
      <label>已選擇巴士站：</label>
      <div id="selectedStopName" style="font-weight: 700; font-size: 1.2rem; margin-bottom: 10px;"></div>
      <label>此站服務路線：</label>
      <div id="routeList"></div>
    </div>

    <div id="urlSection" style="display:none;">
      <label>ETA 查詢連結（可複製）</label>
      <div id="etaUrl" class="url-block"></div>
    </div>

    <div id="etaPreview" class="preview-section" style="display:none;">
      <div class="station-name" id="etaStopDisplay"></div>
      <div class="eta-list" id="etaList"></div>
    </div>

    <div class="footer-clock" id="footerTime"></div>
  </div>

<script>
(async function() {
  const stopSearchInput = document.getElementById('stopSearch');
  const stopResultsDiv = document.getElementById('stopResults');
  const selectedStopSection = document.getElementById('selectedStopSection');
  const selectedStopNameDiv = document.getElementById('selectedStopName');
  const routeListDiv = document.getElementById('routeList');
  const urlSection = document.getElementById('urlSection');
  const etaUrlDiv = document.getElementById('etaUrl');
  const etaPreviewSection = document.getElementById('etaPreview');
  const etaStopDisplay = document.getElementById('etaStopDisplay');
  const etaListDiv = document.getElementById('etaList');
  const footerTime = document.getElementById('footerTime');

  let stopsData = [];
  let routeStopData = [];
  let etaRefreshTimer = null;
  let selectedStop = null;
  let selectedRoute = null;
  let selectedServiceType = "1";

  // Load initial data: stops and route-stop
  async function loadStops() {
    try {
      const res = await fetch('https://data.etabus.gov.hk/v1/transport/kmb/stop');
      const json = await res.json();
      stopsData = json.data || [];
    } catch(e) {
      stopsData = [];
      stopResultsDiv.innerHTML = `<div class="error">載入巴士站資料失敗</div>`;
    }
  }
  async function loadRouteStops() {
    try {
      const res = await fetch('https://data.etabus.gov.hk/v1/transport/kmb/route-stop');
      const json = await res.json();
      routeStopData = json.data || [];
    } catch(e) {
      routeStopData = [];
    }
  }

  // Debounce search input
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    }
  }

  // Search stops matching input keyword
  function searchStops(keyword) {
    keyword = keyword.trim().toLowerCase();
    if(!keyword) return [];
    return stopsData.filter(stop =>
      stop.name_tc.toLowerCase().includes(keyword) ||
      stop.name_en.toLowerCase().includes(keyword) ||
      stop.name_sc.toLowerCase().includes(keyword)
    ).slice(0, 30);
  }

  function renderStopResults(stops) {
    if(stops.length === 0) {
      stopResultsDiv.innerHTML = '<div style="padding:10px;">無符合的巴士站</div>';
      return;
    }
    stopResultsDiv.innerHTML = stops.map(stop => `
      <div class="list-item" data-stop="${stop.stop}">
        <strong>${stop.name_tc}</strong> (${stop.name_en})<br><small>站ID: ${stop.stop}</small>
      </div>
    `).join('');

    stopResultsDiv.querySelectorAll('.list-item').forEach(el => {
      el.onclick = () => {
        const stopId = el.getAttribute('data-stop');
        const stop = stopsData.find(s => s.stop === stopId);
        if(stop) onStopSelected(stop);
      }
    })
  }

  // Handle stop selected
  function onStopSelected(stop) {
    selectedStop = stop;
    stopSearchInput.value = '';
    stopResultsDiv.innerHTML = '';
    selectedStopSection.style.display = 'block';
    selectedStopNameDiv.textContent = `${stop.name_tc} (ID: ${stop.stop})`;

    urlSection.style.display = 'none';
    etaPreviewSection.style.display = 'none';
    selectedRoute = null;
    etaUrlDiv.textContent = '';
    routeListDiv.innerHTML = '載入中...';

    // Show all routes that serve this stop by exact stop ID match
    let servingRoutes = routeStopData.filter(rs => rs.stop === selectedStop.stop);
    if(servingRoutes.length === 0){
      routeListDiv.innerHTML = '<div class="error">該站沒有可用巴士路線資料。</div>';
      return;
    }

    // Unique routes+direction+service_type tuples
    let uniqueRoutes = [];
    const mapKey = new Set();
    servingRoutes.forEach(rstop => {
      const key = `${rstop.route}|${rstop.bound}|${rstop.service_type}`;
      if(!mapKey.has(key)) {
        mapKey.add(key);
        uniqueRoutes.push(rstop);
      }
    });

    // For each unique route, get route info (origin/dest) from route API
    // We will fetch route info for each unique route + bound + service_type
    // but limit concurrency to moderate level:
    const promises = uniqueRoutes.map(rs =>
      fetch(`https://data.etabus.gov.hk/v1/transport/kmb/route/${rs.route}/${rs.bound === 'O' ? 'outbound' : 'inbound'}/${rs.service_type}`)
      .then(r => r.json())
      .then(data => {
         if(data.data) return data.data;
         return null;
      })
      .catch(() => null)
    );

    Promise.all(promises).then(routesInfo => {
      routeListDiv.innerHTML = '';
      routesInfo.forEach((info, idx) => {
        if(!info) return;
        const routeData = uniqueRoutes[idx];
        const routeDiv = document.createElement('div');
        routeDiv.classList.add('route-item');
        routeDiv.innerHTML = `
          <div>${routeData.route} - ${routeData.bound === 'O' ? '往': '返'} ${info.dest_tc}</div>
          <button class="route-button" data-route="${routeData.route}" data-bound="${routeData.bound}" data-service="${routeData.service_type}">查看到站時間</button>
        `;
        routeListDiv.appendChild(routeDiv);
      });

      routeListDiv.querySelectorAll('.route-button').forEach(btn => {
        btn.onclick = () => {
          let route = btn.getAttribute('data-route');
          let bound = btn.getAttribute('data-bound');
          let service = btn.getAttribute('data-service');
          selectedRoute = {route, bound, service};
          showETA(selectedStop.stop, route, service);
        }
      });

      if(routesInfo.length === 0) {
        routeListDiv.innerHTML = '<div class="error">該站沒有有效巴士路線資料。</div>';
      }
    });
  }

  // Show ETA for selected stop & route and refresh every 4s
  function showETA(stopId, routeNum, serviceType) {
    urlSection.style.display = 'block';
    etaPreviewSection.style.display = 'block';
    etaStopDisplay.textContent = `巴士站：${selectedStop.name_tc}，路線：${routeNum}`;

    etaUrlDiv.textContent = `https://data.etabus.gov.hk/v1/transport/kmb/eta/${stopId}/${routeNum}/${serviceType}`;

    if(etaRefreshTimer) clearInterval(etaRefreshTimer);
    fetchAndRenderETA(stopId, routeNum, serviceType);
    etaRefreshTimer = setInterval(() => fetchAndRenderETA(stopId, routeNum, serviceType), 4000);
  }

  async function fetchAndRenderETA(stopId, routeNum, serviceType) {
    etaListDiv.innerHTML = '載入中...';
    try {
      const res = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/eta/${stopId}/${routeNum}/${serviceType}`);
      if(!res.ok) throw new Error(`API error: ${res.status}`);
      const json = await res.json();
      if (!json.data || !json.data.length) {
        etaListDiv.innerHTML = '<div class="error">沒有即時到站資料。</div>';
        return;
      }
      const now = new Date();

      etaListDiv.innerHTML = json.data.map(item => {
        let etaDate = item.eta ? new Date(item.eta) : null;
        let diffMin = etaDate ? Math.ceil((etaDate - now) / 60000) : null;

        if(diffMin !== null && diffMin < 0) diffMin = 0;

        let timeClass = 'red';
        if (diffMin !== null) {
          if (diffMin <= 5) timeClass = 'green';
          else if (diffMin <= 15) timeClass = 'yellow';
          else timeClass = 'red';
        }

        let timeText = etaDate ? `${diffMin} 分 (${etaDate.getHours().toString().padStart(2,'0')}:${etaDate.getMinutes().toString().padStart(2,'0')})` : '暫無預計';

        let remark = item.rmk_tc ? `<span class="remark">${item.rmk_tc}</span>` : '';

        return `
          <div class="eta-item">
            <div class="destination">${item.dest_tc}</div>
            <div class="time ${timeClass}">${timeText}</div>
            ${remark}
          </div>
        `;
      }).join('');
    } catch (err) {
      etaListDiv.innerHTML = `<div class="error">即時資料載入失敗，請稍後再試。</div>`;
    }
  }

  // Footer clock
  setInterval(() => {
    const now = new Date();
    footerTime.textContent = `現在時間：${now.getHours().toString().padStart(2,'0')} : ${now.getMinutes().toString().padStart(2,'0')} : ${now.getSeconds().toString().padStart(2,'0')}`;
  }, 1000);

  // Search input handler with debounce
  const debouncedSearch = debounce(() => {
    const keyword = stopSearchInput.value;
    const results = searchStops(keyword);
    renderStopResults(results);
  }, 300);

  stopSearchInput.addEventListener('input', debouncedSearch);

  // Initial load
  await loadStops();
  await loadRouteStops();
})();
</script>
</body>
</html>
