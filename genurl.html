<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>genurl v2</title>
<style>
  body {
    font-family: Arial, "PingFang HK", "Microsoft JhengHei", sans-serif;
    background: #f5f6fa;
    margin: 0; padding: 0;
    min-height: 100vh;
    color: #205d1e;
  }
  .container {
    max-width: 600px;
    margin: 36px auto;
    background: #fff;
    box-shadow: 0 2px 10px #e0e0e0;
    border-radius: 10px;
    padding: 20px 16px 40px;
  }
  h1 {
    font-size: 1.8em;
    text-align: center;
    margin-top: 0;
    font-weight: 700;
    letter-spacing: 1px;
  }
  label {
    font-weight: 600;
    display: block;
    margin-top: 20px;
    margin-bottom: 4px;
    font-size: 1.1em;
  }
  input[type=text], select {
    width: 100%;
    font-size: 1em;
    padding: 8px 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  button {
    margin-top: 12px;
    padding: 10px 18px;
    background: #388e3c;
    color: white;
    border: none;
    border-radius: 7px;
    font-size: 1em;
    cursor: pointer;
  }
  button:disabled {
    background: #a1d6a1; cursor: not-allowed;
  }
  .list {
    margin-top: 14px;
    max-height: 180px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 7px;
    background: #f0faf0;
  }
  .list-item {
    padding: 8px 10px;
    border-bottom: 1px solid #cee7ce;
    cursor: pointer;
    font-size: 1.05em;
  }
  .list-item:hover {
    background: #def1de;
  }
  .list-item.selected {
    background: #a4dba4;
    font-weight: 700;
  }
  .routes-container {
    margin-top: 16px;
  }
  .route-item {
    background: #e6f7ff;
    margin: 6px 0;
    padding: 10px 15px;
    border-radius: 7px;
    font-weight: 600;
    font-size: 1.1em;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .route-button {
    background: #388e3c;
    color: white;
    border: none;
    border-radius: 7px;
    padding: 6px 14px;
    cursor: pointer;
  }
  .route-button:hover {
    background: #2e7030;
  }
  .url-block {
    margin-top: 20px;
    background: #fcfcf1;
    padding: 14px 18px;
    border-radius: 7px;
    font-family: monospace;
    font-size: 1.05em;
    word-break: break-all;
    user-select: all;
  }
  .preview-section {
    margin-top: 26px;
    border-top: 2px solid #d4ecd4;
    padding-top: 20px;
  }
  .station-name {
    text-align: center;
    font-size: 1.3em;
    font-weight: bold;
    margin-bottom: 14px;
  }
  .eta-list {
    margin-top: 12px;
  }
  .eta-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 14px;
    border-bottom: 1px solid #d7f0d7;
    font-size: 1.1em;
  }
  .eta-item:last-child { border-bottom: none; }
  .destination {
    font-weight: 600;
    color: #205d1e;
    max-width: 65%;
  }
  .time {
    font-weight: 700;
  }
  .time.green { color: #388e3c; }
  .time.yellow { color: #fbc02d; }
  .time.red { color: #c62828; }
  .remark {
    font-size: 0.85em;
    color: #555;
    margin-left: 6px;
  }
  .error {
    color: #c62828;
    text-align: center;
    margin-top: 20px;
    font-weight: bold;
  }
  .footer-clock {
    text-align: center;
    margin-top: 22px;
    font-size: 0.95em;
    color: #666;
  }
</style>
</head>
<body>
<div class="container">
  <h1>KMB 全合一即時到站查詢</h1>

  <label for="stopSearchInput">搜尋巴士站（中英文皆可）:</label>
  <input id="stopSearchInput" type="text" placeholder="例如：天耀 / TIN YIU" autocomplete="off" />
  <div id="stopList" class="list"></div>

  <div id="selectedStopContainer" style="display:none;">
    <label>已選擇巴士站：</label>
    <div id="selectedStopName" style="font-size:1.2em; font-weight:bold; margin-bottom:10px;"></div>

    <label>此站服務路線：</label>
    <div id="routesList" class="routes-container"></div>
  </div>

  <div id="urlContainer" style="display:none;">
    <label>即時到站查詢連結（可複製分享）：</label>
    <div id="generatedUrl" class="url-block"></div>
  </div>

  <div id="etaPreviewSection" class="preview-section" style="display:none;">
    <div class="station-name" id="etaStationName"></div>
    <div class="eta-list" id="etaList"></div>
  </div>

  <div class="footer-clock" id="footerClock"></div>
</div>

<script>
(async function() {
  let allStops = [];
  let allRouteStops = [];
  let selectedStop = null;
  let selectedRoute = null;
  let selectedServiceType = "1";

  const stopSearchInput = document.getElementById("stopSearchInput");
  const stopListDiv = document.getElementById("stopList");
  const selectedStopContainer = document.getElementById("selectedStopContainer");
  const selectedStopNameDiv = document.getElementById("selectedStopName");
  const routesListDiv = document.getElementById("routesList");
  const urlContainer = document.getElementById("urlContainer");
  const generatedUrlDiv = document.getElementById("generatedUrl");
  const etaPreviewSection = document.getElementById("etaPreviewSection");
  const etaStationNameDiv = document.getElementById("etaStationName");
  const etaListDiv = document.getElementById("etaList");
  const footerClock = document.getElementById("footerClock");
  let etaRefreshTimer = null;

  // Fetch all stops
  async function fetchAllStops() {
    let resp = await fetch("https://data.etabus.gov.hk/v1/transport/kmb/stop");
    let json = await resp.json();
    allStops = json.data || [];
  }
  // Fetch all route-stops data
  async function fetchAllRouteStops() {
    let resp = await fetch("https://data.etabus.gov.hk/v1/transport/kmb/route-stop");
    let json = await resp.json();
    allRouteStops = json.data || [];
  }

  // Debounce to limit frequent searches
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Search function for stops
  function searchStops(keyword) {
    if (!keyword.trim()) return [];
    keyword = keyword.trim().toLowerCase();
    return allStops.filter(s =>
      s.name_tc.toLowerCase().includes(keyword) ||
      s.name_en.toLowerCase().includes(keyword) ||
      s.name_sc.toLowerCase().includes(keyword)
    ).slice(0, 30);
  }

  // Render stop search results
  function renderStopsList(stops) {
    if (stops.length === 0) {
      stopListDiv.innerHTML = "<div style='padding:10px;'>找不到相關巴士站。</div>";
      return;
    }
    stopListDiv.innerHTML = stops.map(s =>
      `<div class="list-item" data-stop="${s.stop}">
          <strong>${s.name_tc}</strong> (${s.name_en})<br/>
          <small>ID: ${s.stop}</small>
      </div>`
    ).join('');
    Array.from(stopListDiv.children).forEach(div => {
      div.onclick = () => {
        const stopId = div.getAttribute("data-stop");
        selectedStop = allStops.find(s => s.stop === stopId);
        if (selectedStop) selectStop(selectedStop);
      };
    });
  }

  // Handle stop selection
  function selectStop(stop) {
    stopSearchInput.value = '';
    stopListDiv.innerHTML = '';
    selectedStopContainer.style.display = 'block';
    selectedStopNameDiv.textContent = `${stop.name_tc} (${stop.name_en}), ID: ${stop.stop}`;
    urlContainer.style.display = 'none';
    etaPreviewSection.style.display = 'none';
    selectedRoute = null;
    generatedUrlDiv.innerHTML = '';
    renderRoutesForStop(stop.stop);
  }

  // Render routes serving selected stop
  async function renderRoutesForStop(stopId) {
    routesListDiv.innerHTML = "<div>讀取中...</div>";
    let servingRoutes = allRouteStops.filter(r => r.stop === stopId);
    let uniqueRoutes = [...new Set(servingRoutes.map(r => r.route))].sort();

    if (uniqueRoutes.length === 0) {
      routesListDiv.innerHTML = "<div>該站沒有可用巴士路線資料。</div>";
      return;
    }
    let routeCards = [];
    await Promise.all(uniqueRoutes.map(async route => {
      let infos = [];
      try {
        for (const dir of ['outbound', 'inbound']) {
          let resp = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/route/${route}/${dir}/1`);
          let js = await resp.json();
          if (js.data) infos.push(js.data);
        }
      } catch {} 
      infos.forEach(info => {
        routeCards.push(`
          <div class="route-item">
            <div>${route} - ${info.bound==="O"?"往":"返"} ${info.dest_tc}</div>
            <button class="route-button" data-route="${route}" data-bound="${info.bound}">查看到站時間</button>
          </div>
        `);
      });
    }));

    routesListDiv.innerHTML = routeCards.join('');
    Array.from(routesListDiv.querySelectorAll('.route-button')).forEach(btn => {
      btn.onclick = () => {
        const route = btn.getAttribute("data-route");
        const bound = btn.getAttribute("data-bound");
        selectedRoute = {route, bound};
        generateUrlAndShowETA(selectedStop.stop, route, bound, selectedServiceType);
      };
    });
  }

  // Generate URL and show real-time ETA
  async function generateUrlAndShowETA(stopId, route, bound, serviceType) {
    const url = `${window.location.origin}${window.location.pathname}?stop_id=${stopId}&route=${route}&service_type=${serviceType}`;
    generatedUrlDiv.innerHTML = url;
    urlContainer.style.display = 'block';

    etaPreviewSection.style.display = 'block';
    etaStationNameDiv.textContent = `巴士站: ${selectedStop.name_tc} | 路線: ${route} (${bound === 'O' ? '往' : '返'})`;

    if (etaRefreshTimer) clearInterval(etaRefreshTimer);
    await fetchAndRenderETA(stopId, route, serviceType);
    etaRefreshTimer = setInterval(() => fetchAndRenderETA(stopId, route, serviceType), 4000);
  }

  // Fetch and display ETA data
  async function fetchAndRenderETA(stopId, route, serviceType) {
    etaListDiv.innerHTML = "<div>讀取中…</div>";
    try {
      let resp = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/eta/${stopId}/${route}/${serviceType}`);
      if (!resp.ok) throw new Error('API Error');
      let js = await resp.json();
      if (!Array.isArray(js.data) || js.data.length === 0) {
        etaListDiv.innerHTML = "<div class='error'>沒有即時班次資料。</div>";
        return;
      }
      const now = new Date();
      let etaHtml = js.data.map(item => {
        let etaDate = item.eta ? new Date(item.eta) : null;
        let mins = etaDate ? Math.round((etaDate - now)/60000) : null;
        if (mins !== null && mins < 0) mins = 0;
        let timeClass = !mins ? 'red' : (mins < 5 ? 'green' : (mins < 11 ? 'yellow' : 'red'));
        let timeText = etaDate ?
            `${mins} 分（${etaDate.getHours()}:${String(etaDate.getMinutes()).padStart(2,'0')}）` :
            '暫無預計';
        let remarkText = item.rmk_tc || '';
        return `
          <div class="eta-item">
            <div class="destination">${item.dest_tc}</div>
            <div class="time ${timeClass}">${timeText}</div>
            <div class="remark">${remarkText}</div>
          </div>
        `;
      }).join('');
      etaListDiv.innerHTML = etaHtml;
    } catch (e) {
      etaListDiv.innerHTML = "<div class='error'>即時資料載入失敗，請稍後重試。</div>";
    }
  }

  // Update footer clock every second
  setInterval(() => {
    let now = new Date();
    footerClock.textContent = `現在時間：${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
  }, 1000);

  // Debounced search to reduce API strain
  const debouncedSearch = (function() {
    let timeout;
    return function() {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        let stops = searchStops(stopSearchInput.value);
        renderStopsList(stops);
      }, 300);
    };
  })();
  stopSearchInput.addEventListener('input', debouncedSearch);

  // Initialize data on page load
  await fetchAllStops();
  await fetchAllRouteStops();
})();
</script>
</body>
</html>
